{"version":3,"file":"GenericViewHandler.js","sourceRoot":"","sources":["../../../../../src/lib/controller/browse/view-handlers/GenericViewHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import ytmusic from '../../../YTMusicContext';\nimport { ModelType } from '../../../model';\nimport { type PageContent, type WatchContent, type WatchContinuationContent } from '../../../types/Content';\nimport {type BrowseContinuationEndpoint, type BrowseEndpoint, type SearchContinuationEndpoint, type SearchEndpoint, type WatchContinuationEndpoint, type WatchEndpoint} from '../../../types/Endpoint';\nimport type Endpoint from '../../../types/Endpoint';\nimport { EndpointType } from '../../../types/Endpoint';\nimport AutoplayHelper from '../../../util/AutoplayHelper';\nimport EndpointHelper from '../../../util/EndpointHelper';\nimport ExplodeHelper from '../../../util/ExplodeHelper';\nimport FeedViewHandler, { type FeedView } from './FeedViewHandler';\n\n// From Innertube lib (YouTube.js#Actions)\nconst REQUIRES_SIGNIN_BROWSE_IDS = [\n  'FEmusic_listening_review',\n  'FEmusic_library_landing',\n  'FEmusic_history'\n];\n\nexport type GenericViewBase = FeedView;\n\nexport interface GenericView extends GenericViewBase {\n  name: 'generic';\n}\n\n/**\n * Generic view handler. Contents fetched from endpoint with the EndpointModel.\n */\n\nexport default class GenericViewHandler<V extends GenericViewBase = GenericView> extends FeedViewHandler<V> {\n\n  async browse() {\n    const endpoint = this.getEndpoint();\n    const account = await this.getModel(ModelType.Account).getInfo();\n    if (EndpointHelper.isType(endpoint, EndpointType.Browse) &&\n      REQUIRES_SIGNIN_BROWSE_IDS.includes(endpoint.payload.browseId) &&\n      !account.isSignedIn) {\n      ytmusic.toast('error', ytmusic.getI18n('YTMUSIC_ERR_REQUIRE_SIGN_IN'));\n      throw Error(ytmusic.getI18n('YTMUSIC_ERR_REQUIRE_SIGN_IN'));\n    }\n\n    return super.browse();\n  }\n\n  protected async getContents(): Promise<PageContent> {\n    const endpoint = this.assertEndpointExists(this.getEndpoint());\n    const contents = await this.getModel(ModelType.Endpoint).getContents(endpoint);\n    return this.assertPageContents(contents);\n  }\n\n  protected assertEndpointExists<T extends Endpoint>(endpoint?: T | null): T {\n    if (!endpoint) {\n      ytmusic.toast('error', ytmusic.getI18n('YTMUSIC_ERR_ENDPOINT_INVALID'));\n      throw Error(ytmusic.getI18n('YTMUSIC_ERR_ENDPOINT_INVALID'));\n    }\n    return endpoint;\n  }\n\n  protected assertPageContents(content: PageContent | WatchContent | WatchContinuationContent | null): PageContent {\n    if (content?.type !== 'page') {\n      ytmusic.toast('error', ytmusic.getI18n('YTMUSIC_ERR_ENDPOINT_INVALID'));\n      throw Error(`Expecting page contents, but got ${content?.type}`);\n    }\n    return content;\n  }\n\n  protected async getTracksOnExplode() {\n    const endpoint = this.getEndpoint(true);\n\n    if (!endpoint || !endpoint.payload) {\n      ytmusic.toast('error', ytmusic.getI18n('YTMUSIC_ERR_OP_NOT_SUPPORTED'));\n      throw Error(ytmusic.getI18n('YTMUSIC_ERR_OP_NOT_SUPPORTED'));\n    }\n\n    const endpointPredicate = (endpoint: Endpoint): endpoint is WatchEndpoint => !!(EndpointHelper.isType(endpoint, EndpointType.Watch) && endpoint.payload?.playlistId);\n    const model = this.getModel(ModelType.Endpoint);\n    let targetWatchEndpoint: WatchEndpoint | null = null;\n\n    if (EndpointHelper.isType(endpoint, EndpointType.Browse)) {\n      let contents = await model.getContents(endpoint);\n      let tabs = contents?.tabs || [];\n      if (tabs.length > 1) {\n        // Remaining tabs that can be used to look for watch endpoints\n        tabs = tabs.filter((tab) => !tab.selected && EndpointHelper.isType(tab.endpoint, EndpointType.Browse));\n      }\n      while (!targetWatchEndpoint) {\n        targetWatchEndpoint = this.findAllEndpointsInSection<WatchEndpoint>(contents?.sections, endpointPredicate)[0];\n        if (!targetWatchEndpoint) {\n          const nextTab = tabs.shift();\n          if (nextTab && EndpointHelper.isType(nextTab.endpoint, EndpointType.Browse)) {\n            contents = await model.getContents(nextTab.endpoint);\n          }\n          else {\n            break;\n          }\n        }\n      }\n    }\n    else if (endpointPredicate(endpoint)) {\n      targetWatchEndpoint = endpoint;\n    }\n\n    if (!targetWatchEndpoint) {\n      ytmusic.toast('error', ytmusic.getI18n('YTMUSIC_ERR_NO_PLAYABLE_ITEMS_FOUND'));\n      throw Error('No playable items found');\n    }\n\n    const contents = await model.getContents(targetWatchEndpoint);\n    const musicItems = contents?.playlist?.items?.filter((item) => item.type === 'video' || item.type === 'song') || [];\n    if (musicItems.length > 0) {\n      const commonAutoplayContext = AutoplayHelper.getAutoplayContext(musicItems);\n      musicItems.forEach((item) => {\n        const autoplayContext = commonAutoplayContext || AutoplayHelper.getAutoplayContext(item);\n        if (autoplayContext) {\n          item.autoplayContext = autoplayContext;\n        }\n      });\n    }\n\n    const result = contents?.playlist?.items?.filter((item) => item.type === 'video' || item.type === 'song')\n      .map((item) => ExplodeHelper.getExplodedTrackInfoFromMusicItem(item)) || [];\n\n    return result;\n  }\n\n  protected getEndpoint(explode: true): BrowseEndpoint | WatchEndpoint | WatchContinuationEndpoint | null;\n  protected getEndpoint(explode: false | undefined): BrowseEndpoint | BrowseContinuationEndpoint | SearchEndpoint | SearchContinuationEndpoint | null;\n  protected getEndpoint(explode?: boolean): BrowseEndpoint | BrowseContinuationEndpoint |\n    SearchEndpoint | SearchContinuationEndpoint | WatchEndpoint | WatchContinuationEndpoint | null;\n   \n  protected getEndpoint(_explode?: boolean): Endpoint | null {\n    const view = this.currentView;\n    if (view.continuation) {\n      return view.continuation.endpoint;\n    }\n    return view.endpoint || null;\n  }\n}\n"]}