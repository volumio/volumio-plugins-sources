{"version":3,"file":"BaseViewHandler.js","sourceRoot":"","sources":["../../../../../src/lib/controller/browse/view-handlers/BaseViewHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import ytmusic from '../../../YTMusicContext';\nimport Model, { ModelOf, ModelType } from '../../../model';\nimport { BaseModel } from '../../../model/BaseModel';\nimport { PageElement } from '../../../types';\nimport { QueueItem } from './ExplodableViewHandler';\nimport View, { ContinuationBundle } from './View';\nimport ViewHandler, { RenderedPage } from './ViewHandler';\nimport ViewHelper from './ViewHelper';\nimport Renderer, { RendererOf, RendererType } from './renderers';\nimport BaseRenderer, { RenderedListItem } from './renderers/BaseRenderer';\n\nexport interface ContinuationData {\n  continuation: PageElement.Continuation;\n  prevItemCount: number;\n  bundle: ContinuationBundle;\n}\n\nexport default class BaseViewHandler<V extends View> implements ViewHandler {\n\n  #uri: string;\n  #currentView: V;\n  #previousViews: View[];\n  #models: Partial<Record<ModelType, BaseModel>>;\n  #renderers: Partial<Record<RendererType, BaseRenderer<any>>>;\n\n  constructor(uri: string, currentView: V, previousViews: View[]) {\n    this.#uri = uri;\n    this.#currentView = currentView;\n    this.#previousViews = previousViews;\n    this.#models = {};\n    this.#renderers = {};\n  }\n\n  async browse(): Promise<RenderedPage> {\n    return {};\n  }\n\n  explode(): Promise<QueueItem[]> {\n    throw Error('Operation not supported');\n  }\n\n  get uri(): string {\n    return this.#uri;\n  }\n\n  get currentView(): V {\n    return this.#currentView;\n  }\n\n  get previousViews(): View[] {\n    return this.#previousViews;\n  }\n\n  protected getModel<T extends ModelType>(type: T): ModelOf<T> {\n    if (!this.#models[type]) {\n      let model;\n      switch (type) {\n        case ModelType.Account:\n          model = Model.getInstance(ModelType.Account);\n          break;\n        case ModelType.Config:\n          model = Model.getInstance(ModelType.Config);\n          break;\n        case ModelType.Endpoint:\n          model = Model.getInstance(ModelType.Endpoint);\n          break;\n        case ModelType.Playlist:\n          model = Model.getInstance(ModelType.Playlist);\n          break;\n        case ModelType.Search:\n          model = Model.getInstance(ModelType.Search);\n          break;\n        case ModelType.MusicItem:\n          model = Model.getInstance(ModelType.MusicItem);\n          break;\n        default:\n          throw Error(`Unknown model type: ${type}`);\n      }\n      this.#models[type] = model;\n    }\n\n    return this.#models[type] as ModelOf<T>;\n  }\n\n  protected getRenderer<T extends RendererType>(type: T): RendererOf<T> {\n    if (!this.#renderers[type]) {\n      let renderer: BaseRenderer<any, any>;\n      switch (type) {\n        case RendererType.Channel:\n          renderer = Renderer.getInstance(RendererType.Channel, this.#uri,\n            this.#currentView, this.#previousViews);\n          break;\n        case RendererType.EndpointLink:\n          renderer = Renderer.getInstance(RendererType.EndpointLink, this.#uri,\n            this.#currentView, this.#previousViews);\n          break;\n        case RendererType.Option:\n          renderer = Renderer.getInstance(RendererType.Option, this.#uri,\n            this.#currentView, this.#previousViews);\n          break;\n        case RendererType.OptionValue:\n          renderer = Renderer.getInstance(RendererType.OptionValue, this.#uri,\n            this.#currentView, this.#previousViews);\n          break;\n        case RendererType.Album:\n          renderer = Renderer.getInstance(RendererType.Album, this.#uri,\n            this.#currentView, this.#previousViews);\n          break;\n        case RendererType.Playlist:\n          renderer = Renderer.getInstance(RendererType.Playlist, this.#uri,\n            this.#currentView, this.#previousViews);\n          break;\n        case RendererType.MusicItem:\n          renderer = Renderer.getInstance(RendererType.MusicItem, this.#uri,\n            this.#currentView, this.#previousViews);\n          break;\n        default:\n          throw Error(`Unknown renderer type: ${type}`);\n      }\n      this.#renderers[type] = renderer;\n    }\n    return this.#renderers[type] as RendererOf<T>;\n  }\n\n  protected constructPrevUri() {\n    return ViewHelper.constructPrevUri(this.#currentView, this.#previousViews);\n  }\n\n  #constructContinuationUri(data: ContinuationData) {\n    const { continuation, prevItemCount, bundle } = data;\n    const endpoint = continuation.endpoint;\n\n    const segments = this.#previousViews.map((view) => ViewHelper.constructUriSegmentFromView(view));\n\n    const newView: View = {\n      ...this.#currentView,\n      continuation: { endpoint, prevItemCount }\n    };\n\n    const prevContinuations = this.#currentView.prevContinuations || [];\n    if (this.#currentView.continuation) {\n      prevContinuations.push(this.#currentView.continuation);\n    }\n    if (prevContinuations.length > 0) {\n      newView.prevContinuations = prevContinuations;\n    }\n    else {\n      delete newView.prevContinuations;\n    }\n\n    if (bundle) {\n      newView.continuationBundle = bundle;\n    }\n\n    segments.push(`${ViewHelper.constructUriSegmentFromView(newView)}@noExplode=1`);\n\n    return segments.join('/');\n  }\n\n  protected constructContinuationItem(data: ContinuationData): RenderedListItem {\n    return {\n      service: 'ytmusic',\n      type: 'item-no-menu',\n      'title': data.continuation.text || ytmusic.getI18n('YTMUSIC_MORE'),\n      'uri': this.#constructContinuationUri(data),\n      'icon': 'fa fa-arrow-circle-right'\n    };\n  }\n}\n"]}