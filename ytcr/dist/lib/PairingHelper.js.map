{"version":3,"file":"PairingHelper.js","sourceRoot":"","sources":["../../src/lib/PairingHelper.ts"],"names":[],"mappings":"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","sourcesContent":["import YouTubeCastReceiver, { Constants, Logger } from 'yt-cast-receiver';\nimport ytcr from './YTCRContext.js';\n\nexport default class PairingHelper {\n\n  static #toastFetchingTimer: NodeJS.Timeout | null = null;\n\n  static getManualPairingCode(receiver: YouTubeCastReceiver, logger: Logger): Promise<string | null> {\n    if (receiver.status !== Constants.STATUSES.RUNNING) {\n      return Promise.resolve(null);\n    }\n\n    let timeout: any = null;\n    const service = receiver.getPairingCodeRequestService();\n    const stopService = () => {\n      this.#cancelToastFetching();\n      if (timeout) {\n        clearTimeout(timeout);\n        timeout = null;\n      }\n      service.stop();\n      service.removeAllListeners();\n    };\n\n    if (service.status === Constants.STATUSES.RUNNING) {\n      stopService();\n    }\n\n    return new Promise((resolve) => {\n      service.on('request', () => {\n        logger.debug('[ytcr] Obtaining manual pairing code...');\n        this.#toastFetching();\n      });\n\n      service.on('response', (code: string) => {\n        stopService();\n        logger.debug('[ytcr] Obtained manual pairing code.');\n        const segments = code.match(/.{1,3}/g);\n        const formatted = segments ? segments.join(' ') : code;\n        resolve(formatted);\n      });\n\n      service.on('error', (error: Error) => {\n        stopService();\n        logger.error('[ytcr] Failed to obtain manual pairing code:', error);\n        ytcr.toast('error', ytcr.getI18n('YTCR_FETCH_TV_CODE_ERR', error.message));\n        resolve(null);\n      });\n\n      service.start();\n\n      timeout = setTimeout(() => {\n        stopService();\n        logger.error('[ytcr] Failed to obtain manual pairing code: timeout.');\n        ytcr.toast('error', ytcr.getI18n('YTCR_FETCH_TV_CODE_ERR', 'timeout'));\n        resolve(null);\n      }, 10000);\n    });\n  }\n\n  static #toastFetching() {\n    this.#cancelToastFetching();\n    this.#toastFetchingTimer = setTimeout(() => {\n      ytcr.toast('info', ytcr.getI18n('YTCR_FETCHING_TV_CODE'));\n    }, 4000);\n  }\n\n  static #cancelToastFetching() {\n    if (this.#toastFetchingTimer) {\n      clearTimeout(this.#toastFetchingTimer);\n      this.#toastFetchingTimer = null;\n    }\n  }\n}\n"]}