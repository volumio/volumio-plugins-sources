{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":"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","sourcesContent":["import libQ from 'kew';\r\nimport VConf from 'v-conf';\r\nimport JpRadio from './lib/radio';\r\nimport { BrowseResult } from './lib/models/BrowseResultModel';\r\n\r\nexport = ControllerJpRadio;\r\n\r\nclass ControllerJpRadio {\r\n  private context: any;\r\n  private commandRouter: any;\r\n  private logger: any;\r\n  private configManager: any;\r\n  private config: InstanceType<typeof VConf> | null = null;\r\n  private readonly serviceName = 'jp_radio';\r\n  private appRadio: JpRadio | null = null;\r\n\r\n  constructor(context: any) {\r\n    this.context = context;\r\n    this.commandRouter = context.coreCommand;\r\n    this.logger = context.logger;\r\n    this.configManager = context.configManager;\r\n  }\r\n\r\n  async restartPlugin(): Promise<void> {\r\n    try {\r\n      await this.onStop();\r\n      await this.onStart();\r\n    } catch {\r\n      this.commandRouter.pushToastMessage('error', 'Restart Failed', 'The plugin could not be restarted.');\r\n    }\r\n  }\r\n\r\n  private showRestartModal(): void {\r\n    const message = {\r\n      title: 'Plugin Restart Required',\r\n      message: 'Changes have been made that require the JP Radio plugin to be restarted. Please click the restart button below.',\r\n      size: 'lg',\r\n      buttons: [\r\n        {\r\n          name: this.commandRouter.getI18nString('COMMON.RESTART'),\r\n          class: 'btn btn-info',\r\n          emit: 'callMethod',\r\n          payload: {\r\n            endpoint: 'music_service/jp_radio',\r\n            method: 'restartPlugin',\r\n            data: {}\r\n          }\r\n        },\r\n        {\r\n          name: this.commandRouter.getI18nString('COMMON.CANCEL'),\r\n          class: 'btn btn-info',\r\n          emit: 'closeModals',\r\n          payload: ''\r\n        }\r\n      ]\r\n    };\r\n    this.commandRouter.broadcastMessage('openModal', message);\r\n  }\r\n\r\n  async saveServicePort(data: { servicePort: string }): Promise<void> {\r\n    const newPort = Number(data.servicePort);\r\n    if (!isNaN(newPort) && this.config && this.config.get('servicePort') !== newPort) {\r\n      this.config.set('servicePort', newPort);\r\n      this.showRestartModal();\r\n    }\r\n  }\r\n\r\n  async saveRadikoAccount(data: { radikoUser: string; radikoPass: string }): Promise<void> {\r\n    if (!this.config) return;\r\n    const updated = ['radikoUser', 'radikoPass'].some(\r\n      (key) => this.config!.get(key) !== (data as any)[key]\r\n    );\r\n    if (updated) {\r\n      this.config.set('radikoUser', data.radikoUser);\r\n      this.config.set('radikoPass', data.radikoPass);\r\n      this.showRestartModal();\r\n    }\r\n  }\r\n\r\n  onVolumioStart(): Promise<void> {\r\n    const defer = libQ.defer();\r\n    try {\r\n      const configFile = this.commandRouter.pluginManager.getConfigurationFile(this.context, 'config.json');\r\n      this.config = new VConf();\r\n      this.config.loadFile(configFile);\r\n      defer.resolve();\r\n    } catch (error) {\r\n      defer.reject(error);\r\n    }\r\n    return defer.promise;\r\n  }\r\n  \r\n  onStart(): Promise<void> {\r\n    const defer = libQ.defer();\r\n\r\n    if (!this.config) {\r\n      this.logger.error('Config not initialized onStart');\r\n      defer.reject(new Error('Config not initialized'));\r\n      return defer.promise;\r\n    }\r\n\r\n    const radikoUser = this.config.get('radikoUser');\r\n    const radikoPass = this.config.get('radikoPass');\r\n    const servicePort = this.config.get('servicePort') || 9000;\r\n    const account = radikoUser && radikoPass ? { mail: radikoUser, pass: radikoPass } : null;\r\n\r\n    this.appRadio = new JpRadio(servicePort, this.logger, account, this.commandRouter);\r\n\r\n    this.appRadio.start()\r\n      .then(() => {\r\n        this.addToBrowseSources();\r\n        defer.resolve();\r\n      })\r\n      .catch((err) => {\r\n        this.logger.error('JP_Radio::Failed to start appRadio', err);\r\n        defer.reject(err);\r\n      });\r\n\r\n    return defer.promise;\r\n  }\r\n\r\n  async onStop(): Promise<void> {\r\n    try {\r\n      if (this.appRadio) await this.appRadio.stop();\r\n    } catch (err) {\r\n      this.logger.error('JP_Radio::Error stopping appRadio', err);\r\n    }\r\n    this.commandRouter.volumioRemoveToBrowseSources('RADIKO');\r\n  }\r\n\r\n  getUIConfig(): Promise<any> {\r\n    const defer = libQ.defer();\r\n    const langCode = this.commandRouter.sharedVars.get('language_code') || 'en';\r\n\r\n    this.commandRouter.i18nJson(\r\n      `${__dirname}/i18n/strings_${langCode}.json`,\r\n      `${__dirname}/i18n/strings_en.json`,\r\n      `${__dirname}/UIConfig.json`\r\n    )\r\n    .then((uiconf: any) => {\r\n      const servicePort = this.config.get('servicePort');\r\n      const radikoUser = this.config.get('radikoUser');\r\n      const radikoPass = this.config.get('radikoPass');\r\n\r\n      if (uiconf.sections?.[0]?.content?.[0]) uiconf.sections[0].content[0].value = servicePort;\r\n      if (uiconf.sections?.[1]?.content?.[0]) uiconf.sections[1].content[0].value = radikoUser;\r\n      if (uiconf.sections?.[1]?.content?.[1]) uiconf.sections[1].content[1].value = radikoPass;\r\n\r\n      defer.resolve(uiconf);\r\n    })\r\n    .fail((error: any) => {\r\n      this.logger.error('getUIConfig failed:', error);\r\n      defer.reject(error);\r\n    });\r\n\r\n    return defer.promise;\r\n  }\r\n\r\n  \r\n  getConfigurationFiles(): string[] {\r\n    return ['config.json'];\r\n  }\r\n\r\n  addToBrowseSources(): void {\r\n    this.commandRouter.volumioAddToBrowseSources({\r\n      name: 'RADIKO',\r\n      uri: 'radiko',\r\n      plugin_type: 'music_service',\r\n      plugin_name: this.serviceName,\r\n      albumart: '/albumart?sourceicon=music_service/jp_radio/assets/images/app_radiko.svg'\r\n    });\r\n  }\r\n\r\n  async handleBrowseUri(curUri: string): Promise<BrowseResult | {}> {\r\n    const [baseUri] = curUri.split('?');\r\n\r\n    if (baseUri === 'radiko') {\r\n      if (!this.appRadio) {\r\n        return {};\r\n      }\r\n      return await this.appRadio.radioStations();\r\n    }\r\n\r\n    return {};\r\n  }\r\n\r\n  clearAddPlayTrack(track: any): Promise<any> {\r\n    this.logger.info(`[${new Date().toISOString()}] JP_Radio::clearAddPlayTrack`, track);\r\n    return libQ.resolve();\r\n  }\r\n\r\n  seek(timepos: number): Promise<any> {\r\n    this.logger.info(`[${new Date().toISOString()}] JP_Radio::seek to ${timepos}`);\r\n    return libQ.resolve();\r\n  }\r\n\r\n  stop(): void {\r\n    this.logger.info(`[${new Date().toISOString()}] JP_Radio::stop`);\r\n  }\r\n\r\n  pause(): void {\r\n    this.logger.info(`[${new Date().toISOString()}] JP_Radio::pause`);\r\n  }\r\n\r\n  getState(): void {\r\n    this.logger.info(`[${new Date().toISOString()}] JP_Radio::getState`);\r\n  }\r\n\r\n  parseState(sState: any): void {\r\n    this.logger.info(`[${new Date().toISOString()}] JP_Radio::parseState`);\r\n  }\r\n\r\n  pushState(state: any): any {\r\n    this.logger.info(`[${new Date().toISOString()}] JP_Radio::pushState`);\r\n    return this.commandRouter.servicePushState(state, this.serviceName);\r\n  }\r\n\r\n  explodeUri(uri: string): Promise<any> {\r\n    return libQ.resolve();\r\n  }\r\n\r\n  search(query: any): Promise<any> {\r\n    return libQ.resolve();\r\n  }\r\n\r\n  goto(data: any): Promise<any> {\r\n    return libQ.resolve();\r\n  }\r\n}\r\n"]}