{"version":3,"file":"TagViewHandler.js","sourceRoot":"","sources":["../../../../../src/lib/controller/browse/view-handlers/TagViewHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import { ReleasesByTag } from 'bandcamp-fetch';\nimport bandcamp from '../../../BandcampContext';\nimport TagEntity from '../../../entities/TagEntity';\nimport { ModelType } from '../../../model';\nimport UIHelper, { UI_STYLES } from '../../../util/UIHelper';\nimport View from './View';\nimport { RenderedList, RenderedPage } from './ViewHandler';\nimport ViewHelper from './ViewHelper';\nimport { RendererType } from './renderers';\nimport { RenderedListItem } from './renderers/BaseRenderer';\nimport { ReleasesLoopFetchResult, TagModelGetReleasesParams } from '../../../model/TagModel';\nimport TrackEntity from '../../../entities/TrackEntity';\nimport ExplodableViewHandler from './ExplodableViewHandler';\nimport { AlbumView } from './AlbumViewHandler';\nimport { TrackView } from './TrackViewHandler';\n\nconst FILTER_ICONS: Record<string, string> = {\n  sort: 'fa fa-sort',\n  location: 'fa fa-map-marker',\n  format: 'fa fa-archive'\n};\nconst FILTER_NAMES = [ 'format', 'location', 'sort' ];\n\nexport interface TagView extends View {\n  name: 'tag';\n  tagUrl: string;\n  select?: string;\n}\n\nexport default class TagViewHandler extends ExplodableViewHandler<TagView> {\n\n  async browse(): Promise<RenderedPage> {\n    const view = this.currentView;\n    if (view.select) {\n      return view.select === 'tag' ? this.#browseTags() : this.#browseFilterOptions();\n    }\n    else if (view.tagUrl) {\n      return this.#browseReleases();\n    }\n\n    return this.#browseTags();\n\n  }\n\n  async #browseTags(): Promise<RenderedPage> {\n    const view = this.currentView;\n    const tagUrl = view.tagUrl || null;\n\n    const tags = await this.getModel(ModelType.Tag).getTags();\n    const lists = [\n      this.#getTagsList(tags, 'tags', bandcamp.getI18n('BANDCAMP_TAGS'), 'fa fa-tag', tagUrl),\n      this.#getTagsList(tags, 'locations', bandcamp.getI18n('BANDCAMP_LOCATIONS'), 'fa fa-map-marker', tagUrl)\n    ];\n\n    return {\n      navigation: {\n        prev: { uri: this.constructPrevUri() },\n        lists\n      }\n    };\n  }\n\n  #getTagsList(tags: Record<string, TagEntity[]>, key: string, title: string, icon: string, currentTagUrl: string | null): RenderedList {\n    const tagRenderer = this.getRenderer(RendererType.Tag);\n    const listItems = tags[key].reduce<RenderedListItem[]>((result, tag) => {\n      const rendered = tagRenderer.renderToListItem(tag, {\n        selected: tag.url === currentTagUrl,\n        uri: this.#constructTagUrl(tag.url)\n      });\n      if (rendered) {\n        result.push(rendered);\n      }\n      return result;\n    }, []);\n\n    return {\n      title: UIHelper.addIconToListTitle(icon, title),\n      availableListViews: [ 'list' ],\n      items: listItems\n    };\n  }\n\n  async #browseReleases(): Promise<RenderedPage> {\n    const view = this.currentView;\n    const model = this.getModel(ModelType.Tag);\n    const tagUrl = view.tagUrl;\n\n    const modelParams: TagModelGetReleasesParams = {\n      tagUrl,\n      limit: bandcamp.getConfigValue('itemsPerPage', 47),\n      filters: await this.#getReleasesFiltersFromUriAndDefault()\n    };\n\n    if (view.pageRef) {\n      modelParams.pageToken = view.pageRef.pageToken;\n      modelParams.pageOffset = view.pageRef.pageOffset;\n    }\n\n    const filterOptions = await model.getReleasesAvailableFilters(tagUrl);\n    const releases = await model.getReleases(modelParams);\n    const baseUri = this.#constructUriWithParams(releases.filters);\n    const allLists = [\n      this.#getSelectTagList(baseUri),\n      this.#getFilterOptionsList(releases.filters, filterOptions, baseUri),\n      this.#getReleasesList(releases)\n    ];\n\n    const tagInfo = await model.getTag(tagUrl);\n    const tagRenderer = this.getRenderer(RendererType.Tag);\n    const header = tagRenderer.renderToHeader(tagInfo);\n\n    if (header && allLists[2].items.length > 0) {\n      header.albumart = allLists[2].items[0].albumart;\n    }\n\n    return {\n      navigation: {\n        prev: { uri: this.constructPrevUri() },\n        info: header,\n        lists: allLists\n      }\n    };\n  }\n\n  #getSelectTagList(baseUri: string): RenderedList {\n    return {\n      availableListViews: [ 'list' ],\n      items: [ {\n        service: 'bandcamp',\n        type: 'item-no-menu',\n        title: bandcamp.getI18n('BANDCAMP_SELECT_TAG'),\n        icon: 'fa fa-tag',\n        uri: `${baseUri}@select=tag`\n      } ]\n    };\n  }\n\n  #getFilterOptionsList(current: Record<string, any>, all: ReleasesByTag.Filter[], baseUri: string): RenderedList {\n    const listItems: RenderedListItem[] = [];\n    FILTER_NAMES.forEach((o) => {\n      const filterValue = current[o];\n      if (filterValue != undefined) {\n        const filter = all.find((f) => f.name === o) || null;\n        if (filter) {\n          const opt = filter.options.find((o) => o.value == filterValue);\n          const title = opt ? opt.name : filterValue;\n          listItems.push({\n            service: 'bandcamp',\n            type: 'item-no-menu',\n            title,\n            icon: FILTER_ICONS[o],\n            uri: `${baseUri}@select=${o}`\n          });\n        }\n      }\n    });\n\n    return {\n      title: bandcamp.getI18n('BANDCAMP_RELEASES'),\n      availableListViews: [ 'list' ],\n      items: listItems\n    };\n  }\n\n  #getReleasesList(releases: ReleasesLoopFetchResult): RenderedList {\n    const albumRenderer = this.getRenderer(RendererType.Album);\n    const trackRenderer = this.getRenderer(RendererType.Track);\n    const listItems = releases.items.reduce<RenderedListItem[]>((result, item) => {\n      let rendered;\n      if (item.type === 'album') {\n        rendered = albumRenderer.renderToListItem(item);\n      }\n      else if (item.type === 'track') {\n        rendered = trackRenderer.renderToListItem(item, true, true);\n      }\n      if (rendered) {\n        result.push(rendered);\n      }\n      return result;\n    }, []);\n\n    const nextPageRef = this.constructPageRef(releases.nextPageToken, releases.nextPageOffset);\n    if (nextPageRef) {\n      const nextUri = this.constructNextUri(nextPageRef);\n      listItems.push(this.constructNextPageItem(nextUri));\n    }\n    return {\n      availableListViews: [ 'list', 'grid' ],\n      items: listItems\n    };\n  }\n\n  async #browseFilterOptions(): Promise<RenderedPage> {\n    const view = this.currentView;\n    const filterName = view.select;\n\n    if (!filterName) {\n      throw Error('Target filter not specified');\n    }\n\n    const tagUrl = view.tagUrl;\n    const filterOptions = await this.getModel(ModelType.Tag).getReleasesAvailableFilters(tagUrl);\n    const filter = filterOptions.find((f) => f.name === filterName) || null;\n    let listItems: RenderedListItem[];\n    if (filter && view.select) {\n      listItems = filter.options.reduce<RenderedListItem[]>((result, opt) => {\n        const isSelected = opt.value.toString() === view[filterName];\n        let title = opt.name;\n        if (isSelected) {\n          title = UIHelper.styleText(title, UI_STYLES.LIST_ITEM_SELECTED);\n        }\n        result.push({\n          service: 'bandcamp',\n          type: 'item-no-menu',\n          title,\n          icon: isSelected ? 'fa fa-check' : 'fa',\n          uri: this.#constructFilterOptionUrl(filterName, opt.value)\n        });\n\n        return result;\n      }, []);\n    }\n    else {\n      listItems = [];\n    }\n\n    let title = bandcamp.getI18n(`BANDCAMP_SELECT_${filterName.toUpperCase()}`);\n    title = UIHelper.addIconToListTitle(FILTER_ICONS[filterName], title);\n\n    const lists: RenderedList[] = [ {\n      title,\n      availableListViews: [ 'list' ],\n      items: listItems\n    } ];\n\n    return {\n      navigation: {\n        prev: { uri: this.constructPrevUri() },\n        lists\n      }\n    };\n  }\n\n  #constructTagUrl(tagUrl: string) {\n    const targetView = {\n      ...this.currentView\n    };\n\n    if (this.currentView.tagUrl !== tagUrl) {\n      delete targetView.pageRef;\n      delete targetView.prevPageRefs;\n      targetView.tagUrl = tagUrl;\n    }\n    delete targetView.select;\n\n    return ViewHelper.constructUriFromViews([\n      ...this.previousViews,\n      targetView\n    ]);\n  }\n\n  #constructFilterOptionUrl(optionName: string, optionValue: string | number) {\n    const targetView = {\n      ...this.currentView\n    };\n\n    if (this.currentView[optionName] !== optionValue.toString()) {\n      delete targetView.pageRef;\n      delete targetView.prevPageRefs;\n      targetView[optionName] = optionValue;\n    }\n    delete targetView.select;\n\n    return ViewHelper.constructUriFromViews([\n      ...this.previousViews,\n      targetView\n    ]);\n  }\n\n  #constructUriWithParams(params: object) {\n    const targetView = {\n      ...this.currentView,\n      ...params\n    };\n\n    return ViewHelper.constructUriFromViews([\n      ...this.previousViews,\n      targetView\n    ]);\n  }\n\n  async #getReleasesFiltersFromUriAndDefault() {\n    const view = this.currentView;\n    const tagUrl = view.tagUrl;\n    const model = this.getModel(ModelType.Tag);\n    const filterOptions = await model.getReleasesAvailableFilters(tagUrl);\n    const allowedFilterOptions = filterOptions.filter((filter) => FILTER_NAMES.includes(filter.name));\n    const defaultFilters = allowedFilterOptions.reduce<Record<string, any>>((result, f) => {\n      const selected = f.options.find((o) => o.selected);\n      if (selected) {\n        result[f.name] = selected.value;\n      }\n      return result;\n    }, {});\n    const filtersFromView = Object.keys(view).reduce<Record<string, any>>((result, key) => {\n      if (FILTER_NAMES.includes(key)) {\n        result[key] = view[key];\n      }\n      return result;\n    }, {});\n    return {\n      ...defaultFilters,\n      ...filtersFromView\n    };\n  }\n\n  async getTracksOnExplode() {\n    const view = this.currentView;\n    const tagUrl = view.tagUrl;\n\n    if (!tagUrl) {\n      throw Error('Tag URL missing');\n    }\n\n    const modelParams: TagModelGetReleasesParams = {\n      tagUrl,\n      limit: bandcamp.getConfigValue('itemsPerPage', 47),\n      filters: await this.#getReleasesFiltersFromUriAndDefault()\n    };\n\n    if (view.pageRef) {\n      modelParams.pageToken = view.pageRef.pageToken;\n      modelParams.pageOffset = view.pageRef.pageOffset;\n    }\n\n    const releases = await this.getModel(ModelType.Tag).getReleases(modelParams);\n    const tracks = releases.items.reduce<TrackEntity[]>((result, release) => {\n      if (release.type === 'album' && release.featuredTrack?.streamUrl) {\n        const track: TrackEntity = {\n          type: 'track',\n          name: release.featuredTrack.name,\n          thumbnail: release.thumbnail,\n          artist: release.artist,\n          album: {\n            type: 'album',\n            name: release.name,\n            url: release.url\n          },\n          position: release.featuredTrack.position,\n          streamUrl: release.featuredTrack.streamUrl\n        };\n        result.push(track);\n      }\n      else if (release.type === 'track') {\n        const track: TrackEntity = {\n          type: 'track',\n          name: release.name,\n          url: release.url,\n          thumbnail: release.thumbnail,\n          artist: release.artist,\n          streamUrl: release.streamUrl\n        };\n        result.push(track);\n      }\n      return result;\n    }, []);\n\n    return tracks;\n  }\n\n  /**\n   * Override\n   *\n   * Track uri - one of:\n   * - bandcamp/album@albumUrl={...}@track={...}@artistUrl={...}\n   * - bandcamp/track@trackUrl={...}@artistUrl={...}@albumurl={...}\n   */\n  getTrackUri(track: TrackEntity) {\n    const artistUrl = track.artist?.url || null;\n    const albumUrl = track.album?.url || artistUrl;\n    const trackUrl = track.url || null;\n\n    if (track.album && albumUrl) {\n      const albumView: AlbumView = {\n        name: 'album',\n        albumUrl\n      };\n      if (track.position) {\n        albumView.track = track.position.toString();\n      }\n      if (artistUrl) {\n        albumView.artistUrl = artistUrl;\n      }\n\n      return `bandcamp/${ViewHelper.constructUriSegmentFromView(albumView)}`;\n    }\n\n    if (trackUrl) {\n      const trackView: TrackView = {\n        name: 'track',\n        trackUrl\n      };\n      if (artistUrl) {\n        trackView.artistUrl = artistUrl;\n      }\n      if (albumUrl) {\n        trackView.albumUrl = albumUrl;\n      }\n      return `bandcamp/${ViewHelper.constructUriSegmentFromView(trackView)}`;\n    }\n\n    return null;\n  }\n}\n"]}