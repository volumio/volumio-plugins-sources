{"version":3,"file":"SearchViewHandler.js","sourceRoot":"","sources":["../../../../../src/lib/controller/browse/view-handlers/SearchViewHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import bandcamp from '../../../BandcampContext';\nimport { ModelType } from '../../../model';\nimport { SearchItemType, SearchModelGetSearchResultsParams } from '../../../model/SearchModel';\nimport UIHelper from '../../../util/UIHelper';\nimport BaseViewHandler from './BaseViewHandler';\nimport View from './View';\nimport { RenderedPage } from './ViewHandler';\nimport { RendererType } from './renderers';\nimport { RenderedListItem } from './renderers/BaseRenderer';\n\nexport interface SearchView extends View {\n  name: 'search';\n  query: string;\n  combinedSearch?: '1';\n  itemType?: SearchItemType\n}\n\nexport default class SearchViewHandler extends BaseViewHandler<SearchView> {\n\n  async browse(): Promise<RenderedPage> {\n    const view = this.currentView;\n\n    if (!view.query) {\n      throw Error('Search query missing');\n    }\n\n    const modelParams: SearchModelGetSearchResultsParams = {\n      query: view.query,\n      itemType: SearchItemType.All,\n      limit: view.combinedSearch ? bandcamp.getConfigValue('combinedSearchResults', 17) : bandcamp.getConfigValue('itemsPerPage', 47)\n    };\n\n    if (view.pageRef) {\n      modelParams.pageToken = view.pageRef.pageToken;\n      modelParams.pageOffset = view.pageRef.pageOffset;\n    }\n\n    if (view.itemType) {\n      modelParams.itemType = view.itemType;\n    }\n\n    const searchResults = await this.getModel(ModelType.Search).getSearchResults(modelParams);\n    const renderer = this.getRenderer(RendererType.SearchResult);\n    const listItems = searchResults.items.reduce<RenderedListItem[]>((result, item) => {\n      const rendered = renderer.renderToListItem(item);\n      if (rendered) {\n        result.push(rendered);\n      }\n      return result;\n    }, []);\n\n    const nextPageRef = this.constructPageRef(searchResults.nextPageToken, searchResults.nextPageOffset);\n    if (nextPageRef) {\n      const nextUri = this.constructNextUri(nextPageRef);\n      listItems.push(this.constructNextPageItem(nextUri));\n    }\n\n    let titleKey;\n    switch (view.itemType) {\n      case SearchItemType.ArtistsAndLabels:\n        titleKey = 'BANDCAMP_SEARCH_ARTISTS_AND_LABELS_TITLE';\n        break;\n      case SearchItemType.Albums:\n        titleKey = 'BANDCAMP_SEARCH_ALBUMS_TITLE';\n        break;\n      case SearchItemType.Tracks:\n        titleKey = 'BANDCAMP_SEARCH_TRACKS_TITLE';\n        break;\n      default:\n        titleKey = 'BANDCAMP_SEARCH_TITLE';\n    }\n    if (!view.combinedSearch) {\n      titleKey += '_FULL';\n    }\n    const pageTitle = UIHelper.addBandcampIconToListTitle(bandcamp.getI18n(titleKey, view.query));\n\n    return {\n      navigation: {\n        prev: { uri: this.constructPrevUri() },\n        lists: [\n          {\n            availableListViews: [ 'list', 'grid' ],\n            items: listItems,\n            title: pageTitle\n          }\n        ]\n      }\n    };\n  }\n}\n"]}