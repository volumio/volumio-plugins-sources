{"version":3,"file":"ArticleViewHandler.js","sourceRoot":"","sources":["../../../../../src/lib/controller/browse/view-handlers/ArticleViewHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import { ArticleCategory, ArticleCategorySection } from 'bandcamp-fetch';\nimport bandcamp from '../../../BandcampContext';\nimport AlbumEntity from '../../../entities/AlbumEntity';\nimport ArticleEntity, { ArticleEntityMediaItem } from '../../../entities/ArticleEntity';\nimport TrackEntity from '../../../entities/TrackEntity';\nimport { ModelType } from '../../../model';\nimport UIHelper, { UILink, UI_STYLES } from '../../../util/UIHelper';\nimport View from './View';\nimport { RenderedList, RenderedPage } from './ViewHandler';\nimport { RendererType } from './renderers';\nimport { RenderedListItem } from './renderers/BaseRenderer';\nimport ViewHelper from './ViewHelper';\nimport ExplodableViewHandler from './ExplodableViewHandler';\nimport { ArticleModelGetArticlesParams } from '../../../model/ArticleModel';\nimport { AlbumView } from './AlbumViewHandler';\nimport { TrackView } from './TrackViewHandler';\n\nconst ARTICLE_CATEGORY_ALL = {\n  url: 'all',\n  name: 'All categories'\n};\n\nexport interface ArticleView extends View {\n  name: 'article';\n  articleUrl?: string;\n  select?: boolean;\n  categoryUrl?: string;\n  mediaItemRef?: string;\n  track?: string;\n}\n\ninterface ArticleMediaItemExplodeTrack extends TrackEntity {\n  // For `getTrackUri()`\n  articleUrl: string;\n  mediaItemRef?: string;\n}\n\nexport default class ArticleViewHandler extends ExplodableViewHandler<ArticleView> {\n\n  browse(): Promise<RenderedPage> {\n    const view = this.currentView;\n    if (view.articleUrl) {\n      return this.#browseArticle(view.articleUrl);\n    }\n    else if (view.select) {\n      return this.#browseCategories();\n    }\n\n    return this.#browseList();\n\n  }\n\n  async #browseList(): Promise<RenderedPage> {\n    const category = await this.#getCategoryFromUriOrDefault();\n    if (!category.url) {\n      throw Error('Category URL missing');\n    }\n    const lists: RenderedList[] = [ this.#getParamsList(category) ];\n    const articleList = await this.#getArticleList(category.url);\n    lists.push(articleList);\n\n    return {\n      navigation: {\n        prev: { uri: this.constructPrevUri() },\n        lists\n      }\n    };\n  }\n\n  async #getCategoryFromUriOrDefault(): Promise<ArticleCategory> {\n    const categoryUrl = this.currentView.categoryUrl;\n    if (categoryUrl === ARTICLE_CATEGORY_ALL.url) {\n      return ARTICLE_CATEGORY_ALL;\n    }\n\n    if (categoryUrl) {\n      const categorySections = await this.getModel(ModelType.Article).getArticleCategories();\n      const category = this.#findCategoryInSections(categoryUrl, categorySections);\n      if (category) {\n        return category;\n      }\n    }\n\n    return bandcamp.getConfigValue('defaultArticleCategory', ARTICLE_CATEGORY_ALL, true);\n  }\n\n  #findCategoryInSections(categoryUrl: string, sections: ArticleCategorySection[]): ArticleCategory | null {\n    for (const section of sections) {\n      if (section.sections) {\n        const result = this.#findCategoryInSections(categoryUrl, section.sections);\n        if (result) {\n          return result;\n        }\n      }\n      else if (section.categories) {\n        const result = section.categories.find((category) => category.url === categoryUrl);\n        if (result) {\n          return result;\n        }\n      }\n    }\n    return null;\n  }\n\n  #getParamsList(category: ArticleCategory) {\n    const setDefaultJS = `\n                const params = ${JSON.stringify(category)};\n                const payload = {\n                    'endpoint': 'music_service/bandcamp',\n                    'method': 'saveDefaultArticleCategory',\n                    'data': params\n                };\n                angular.element('#browse-page').scope().browse.socketService.emit('callMethod', payload);`;\n    const setDefaultLink: UILink = {\n      url: '#',\n      icon: { type: 'fa', class: 'fa fa-cog' },\n      text: bandcamp.getI18n('BANDCAMP_SET_DEFAULT_ARTICLE_CATEGORY'),\n      onclick: setDefaultJS.replace(/\"/g, '&quot;').replace(/\\r?\\n|\\r/g, '')\n    };\n    const title = UIHelper.constructListTitleWithLink(UIHelper.addBandcampIconToListTitle(bandcamp.getI18n('BANDCAMP_DAILY')), setDefaultLink, true);\n    const paramsList: RenderedList = {\n      title,\n      availableListViews: [ 'list' ],\n      items: []\n    };\n    const categoryName = category.url !== ARTICLE_CATEGORY_ALL.url ? category.name : bandcamp.getI18n('BANDCAMP_ALL_CATEGORIES');\n    paramsList.items.push({\n      service: 'bandcamp',\n      type: 'item-no-menu',\n      title: categoryName,\n      icon: 'fa fa-filter',\n      uri: `${this.uri}@select=category`\n    });\n    return paramsList;\n  }\n\n  async #getArticleList(categoryUrl: string): Promise<RenderedList> {\n    const view = this.currentView;\n    const modelParams: ArticleModelGetArticlesParams = {\n      limit: view.inSection ? bandcamp.getConfigValue('itemsPerSection', 5) : bandcamp.getConfigValue('itemsPerPage', 47)\n    };\n\n    if (view.pageRef) {\n      modelParams.pageToken = view.pageRef.pageToken;\n      modelParams.pageOffset = view.pageRef.pageOffset;\n    }\n\n    if (categoryUrl !== ARTICLE_CATEGORY_ALL.url) {\n      modelParams.categoryUrl = categoryUrl;\n    }\n\n    const articleList = await this.getModel(ModelType.Article).getArticles(modelParams);\n    const articleRenderer = this.getRenderer(RendererType.Article);\n    const listItems = articleList.items.reduce<RenderedListItem[]>((result, article) => {\n      const rendered = articleRenderer.renderToListItem(article);\n      if (rendered) {\n        result.push(rendered);\n      }\n      return result;\n    }, []);\n    const nextPageRef = this.constructPageRef(articleList.nextPageToken, articleList.nextPageOffset);\n    if (nextPageRef) {\n      const nextUri = this.constructNextUri(nextPageRef);\n      listItems.push(this.constructNextPageItem(nextUri));\n    }\n\n    return {\n      availableListViews: [ 'list', 'grid' ],\n      items: listItems\n    };\n  }\n\n  async #browseCategories(): Promise<RenderedPage> {\n    const currentCategory = await this.#getCategoryFromUriOrDefault();\n    const firstList: RenderedList = {\n      title: UIHelper.addIconToListTitle('fa fa-filter', bandcamp.getI18n('BANDCAMP_ARTICLE_CATEGORIES')),\n      availableListViews: [ 'list' ],\n      items: []\n    };\n    let allCategoriesTitle = bandcamp.getI18n('BANDCAMP_ALL_CATEGORIES');\n    const isAllCategories = currentCategory.url === ARTICLE_CATEGORY_ALL.url;\n    if (isAllCategories) {\n      allCategoriesTitle = UIHelper.styleText(allCategoriesTitle, UI_STYLES.LIST_ITEM_SELECTED);\n    }\n    firstList.items.push({\n      service: 'bandcamp',\n      type: 'item-no-menu',\n      title: allCategoriesTitle,\n      icon: isAllCategories ? 'fa fa-check' : 'fa',\n      uri: this.#constructArticleCategoryUri(ARTICLE_CATEGORY_ALL.url)\n    });\n\n    const categorySections = await this.getModel(ModelType.Article).getArticleCategories();\n    const lists = this.#getArticleCategoryListPerSection(categorySections, currentCategory);\n    lists.unshift(firstList);\n\n    return {\n      navigation: {\n        prev: { uri: this.constructPrevUri() },\n        lists\n      }\n    };\n  }\n\n  #getArticleCategoryListPerSection(sections: ArticleCategorySection[], currentCategory: ArticleCategory, lists: RenderedList[] = []) {\n    sections.forEach((section) => {\n      if (section.sections) {\n        this.#getArticleCategoryListPerSection(section.sections, currentCategory, lists);\n      }\n      else if (section.categories) {\n        const categoryList: RenderedList = {\n          title: section.title,\n          availableListViews: [ 'list' ],\n          items: []\n        };\n        section.categories.forEach((category) => {\n          if (category.url) {\n            const isSelected = currentCategory ? currentCategory.url === category.url : false;\n            let title = category.name;\n            if (isSelected) {\n              title = UIHelper.styleText(title, UI_STYLES.LIST_ITEM_SELECTED);\n            }\n            categoryList.items.push({\n              service: 'bandcamp',\n              type: 'item-no-menu',\n              title,\n              icon: isSelected ? 'fa fa-check' : 'fa',\n              uri: this.#constructArticleCategoryUri(category.url)\n            });\n          }\n        });\n\n        lists.push(categoryList);\n      }\n    });\n\n    return lists;\n  }\n\n  #constructArticleCategoryUri(categoryUrl: string) {\n    const targetView = { ...this.currentView };\n\n    if (targetView.categoryUrl !== categoryUrl) {\n      delete targetView.pageRef;\n      delete targetView.prevPageRefs;\n      if (categoryUrl) {\n        targetView.categoryUrl = categoryUrl;\n      }\n      else {\n        delete targetView.categoryUrl;\n      }\n    }\n    delete targetView.select;\n\n    return ViewHelper.constructUriFromViews([ ...this.previousViews, targetView ]);\n  }\n\n  async #browseArticle(articleUrl: string) {\n    const article = await this.getModel(ModelType.Article).getArticle(articleUrl);\n\n    return {\n      navigation: {\n        prev: { uri: this.constructPrevUri() },\n        info: this.getRenderer(RendererType.Article).renderToHeader(article),\n        lists: this.#getArticleSectionLists(article)\n      }\n    };\n  }\n\n  #getArticleSectionLists(article: ArticleEntity) {\n    // Each 'list' in Volumio contains the article section's text,\n    // As well as the track featured in the next section (if any).\n    // If the article covers a single media item (album / track) and\n    // There is no nextSection, then all tracks will be shown instead\n    // Of just the featured track.\n    const articleRenderer = this.getRenderer(RendererType.Article);\n    const isSingleMediaItem = article.mediaItems?.length === 1;\n    const lists: RenderedList[] = [];\n\n    article.sections?.forEach((section, sectionIndex, allSections) => {\n      const nextSection = allSections[sectionIndex + 1];\n      let listItems: RenderedListItem[] = [];\n      let title = '';\n\n      // First section has 'View on Bandcamp' link\n      if (sectionIndex === 0) {\n        const viewArticleLink: UILink = {\n          url: article.url,\n          text: bandcamp.getI18n('BANDCAMP_VIEW_LINK_ARTICLE'),\n          icon: { type: 'bandcamp' },\n          target: '_blank'\n        };\n        title = UIHelper.constructListTitleWithLink('', viewArticleLink, true);\n      }\n\n      // Section text\n      title += UIHelper.wrapInDiv(this.#formatArticleText(section.text), UI_STYLES.ARTICLE_SECTION.TEXT);\n\n      // Next section's featured track (or all tracks if single media item)\n      if (isSingleMediaItem && !nextSection) {\n        const album = article.mediaItems?.find((mi) => mi.type === 'album') as ArticleEntityMediaItem<AlbumEntity>;\n        if (album) {\n          let albumTitle = '';\n          if (album.artist) {\n            albumTitle = `${UIHelper.styleText(album.artist.name, UI_STYLES.ARTICLE_SECTION.MEDIA_ITEM_ARTIST)}<br/>`;\n          }\n          albumTitle += UIHelper.styleText(album.name, UI_STYLES.ARTICLE_SECTION.MEDIA_ITEM_NAME);\n          const gotoLink = this.#getGoToMediaItemLink(album);\n          if (gotoLink) {\n            let titleWithGoto = UIHelper.constructListTitleWithLink(albumTitle, gotoLink, true);\n            titleWithGoto = UIHelper.wrapInDiv(titleWithGoto, 'position: relative; top: 18px;');\n            title += titleWithGoto;\n          }\n          listItems = album.tracks?.map((track) => articleRenderer.renderMediaItemTrack(article, album, track)) || [];\n        }\n      }\n      else if (nextSection?.mediaItemRef) {\n        const mediaItem = article.mediaItems?.find((mi) => mi.mediaItemRef === nextSection.mediaItemRef);\n        if (mediaItem) {\n          let featuredTrack;\n          if (mediaItem.type === 'album') {\n            const album = mediaItem as ArticleEntityMediaItem<AlbumEntity>;\n            featuredTrack = album.tracks?.find((tr) => tr.position == album.featuredTrackPosition);\n          }\n          if (mediaItem.type === 'track') {\n            featuredTrack = mediaItem;\n          }\n          if (featuredTrack) {\n            let mediaItemTitle = '';\n            if (nextSection.heading) {\n              if (mediaItem.artist) {\n                mediaItemTitle = `${UIHelper.styleText(mediaItem.artist.name, UI_STYLES.ARTICLE_SECTION.MEDIA_ITEM_ARTIST)}<br/>`;\n              }\n              mediaItemTitle += UIHelper.styleText(mediaItem.name, UI_STYLES.ARTICLE_SECTION.MEDIA_ITEM_NAME);\n            }\n            const gotoLink = this.#getGoToMediaItemLink(mediaItem);\n            if (gotoLink) {\n              let titleWithGoto = UIHelper.constructListTitleWithLink(mediaItemTitle, gotoLink, true);\n              if (!nextSection.heading) {\n                titleWithGoto = UIHelper.wrapInDiv(titleWithGoto, 'position: relative; top: 28px;');\n              }\n              else {\n                titleWithGoto = UIHelper.wrapInDiv(titleWithGoto, 'position: relative; top: 18px;');\n              }\n              title += titleWithGoto;\n            }\n            listItems.push(articleRenderer.renderMediaItemTrack(article, mediaItem, featuredTrack));\n          }\n        }\n      }\n\n      if (sectionIndex > 0) {\n        title = UIHelper.wrapInDiv(title, 'width: 100%; margin-top: -48px;');\n      }\n      else {\n        title = UIHelper.wrapInDiv(title, 'width: 100%;');\n      }\n      if (!UIHelper.supportsEnhancedTitles()) {\n        title = bandcamp.getI18n('BANDCAMP_UI_CONTENT_HIDDEN');\n      }\n\n      lists.push({\n        title,\n        availableListViews: [ 'list' ],\n        items: listItems\n      });\n\n    });\n\n    if (article.category?.url) {\n      const articleView: ArticleView = {\n        name: 'article',\n        categoryUrl: article.category.url\n      };\n      const moreUri = `${this.uri}/${ViewHelper.constructUriSegmentFromView(articleView)}`;\n      const moreItem: RenderedListItem = {\n        service: 'bandcamp',\n        type: 'item-no-menu',\n        'title': bandcamp.getI18n('BANDCAMP_MORE_CATEGORY_ARTICLES', article.category.name),\n        'uri': `${moreUri}@noExplode=1`,\n        'icon': 'fa fa-arrow-circle-right'\n      };\n\n      const last = lists[lists.length - 1];\n      if (last?.items?.length === 0) {\n        last.items.push(moreItem);\n      }\n      else {\n        lists.push({\n          availableListViews: [ 'list' ],\n          items: [ moreItem ]\n        });\n      }\n    }\n\n    return lists;\n  }\n\n  #formatArticleText(s: string): string {\n    return s.replace(/(?:\\r\\n|\\r|\\n)/g, '<br/>');\n  }\n\n  #getGoToMediaItemLink(mediaItem: ArticleEntityMediaItem<AlbumEntity | TrackEntity>): UILink | null {\n    if (!mediaItem.url) {\n      return null;\n    }\n    let gotoView;\n    if (mediaItem.type === 'album') {\n      gotoView = {\n        name: 'album',\n        albumUrl: mediaItem.url\n      } as AlbumView;\n    }\n    else {\n      gotoView = {\n        name: 'track',\n        trackUrl: mediaItem.url\n      } as TrackView;\n    }\n    const gotoPath = `${this.uri}/${ViewHelper.constructUriSegmentFromView(gotoView)}`;\n    const gotoText = mediaItem.type === 'album' ? bandcamp.getI18n('BANDCAMP_GO_TO_ALBUM') : bandcamp.getI18n('BANDCAMP_GO_TO_TRACK');\n    return {\n      url: '#',\n      text: gotoText,\n      onclick: `angular.element('#browse-page').scope().browse.fetchLibrary({uri: '${gotoPath}'})`,\n      icon: {\n        type: 'fa',\n        class: 'fa fa-arrow-circle-right',\n        float: 'right',\n        color: '#54c688'\n      }\n    };\n  }\n\n  async getTracksOnExplode(): Promise<ArticleMediaItemExplodeTrack | ArticleMediaItemExplodeTrack[]> {\n    const articleUrl = this.currentView.articleUrl;\n    if (!articleUrl) {\n      throw Error('No article URL specified');\n    }\n\n    const _setTrackProps = (track: TrackEntity, article: ArticleEntity, mediaItem: ArticleEntityMediaItem<AlbumEntity | TrackEntity>) => {\n      const result: ArticleMediaItemExplodeTrack = {\n        ...track,\n        articleUrl: article.url,\n        mediaItemRef: mediaItem.mediaItemRef\n      };\n\n      // Set props so track can be parsed\n      result.thumbnail = mediaItem.thumbnail;\n      delete result.artist;\n      if (mediaItem.artist) {\n        result.artist = mediaItem.artist;\n      }\n      if (mediaItem.type === 'album') {\n        result.album = {\n          type: 'album',\n          name: mediaItem.name,\n          url: mediaItem.url\n        };\n      }\n\n      return result;\n    };\n\n    const article = await this.getModel(ModelType.Article).getArticle(articleUrl);\n    const { mediaItemRef, track } = this.currentView;\n    if (mediaItemRef && track) {\n      const trackPosition = parseInt(track, 10);\n      // Return track corresponding to mediaItemRef and track position\n      const mediaItem = article.mediaItems?.find((mi) => mi.mediaItemRef === mediaItemRef);\n      if (mediaItem?.type === 'album') {\n        const track = mediaItem.tracks?.find((tr) => tr.position === trackPosition);\n        if (track) {\n          return _setTrackProps(track, article, mediaItem);\n        }\n      }\n      // Not found\n      return [];\n    }\n\n    // Return all featured tracks\n    const tracks = article.mediaItems?.reduce<ArticleMediaItemExplodeTrack[]>((result, mediaItem) => {\n      let track;\n      if (mediaItem.type === 'album') {\n        track = mediaItem.tracks?.find((tr) => tr.position == mediaItem.featuredTrackPosition);\n      }\n      else if (mediaItem.type === 'track') {\n        track = mediaItem;\n      }\n      if (track) {\n        result.push(_setTrackProps(track, article, mediaItem));\n      }\n      return result;\n    }, []);\n\n    return tracks || [];\n  }\n\n  /**\n   * Override\n   *\n   * Track uri:\n   * bandcamp/articles@articleUrl={articleUrl}@mediaItemRef={...}@track={trackPosition}@artistUrl={...}@albumUrl={...}\n   */\n  protected getTrackUri(track: ArticleMediaItemExplodeTrack): string | null {\n    const artistUrl = track.artist?.url || null;\n    const albumUrl = track.album?.url || artistUrl;\n\n    const articleView: ArticleView = {\n      name: 'article',\n      articleUrl: track.articleUrl,\n      mediaItemRef: track.mediaItemRef,\n      track: track.position?.toString()\n    };\n\n    if (artistUrl) {\n      articleView.artistUrl = artistUrl;\n    }\n    if (albumUrl) {\n      articleView.albumUrl = albumUrl;\n    }\n\n    const uri = `bandcamp/${ViewHelper.constructUriSegmentFromView(articleView)}`;\n\n    return uri;\n  }\n}\n"]}