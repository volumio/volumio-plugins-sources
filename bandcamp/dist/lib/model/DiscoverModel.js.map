{"version":3,"file":"DiscoverModel.js","sourceRoot":"","sources":["../../../src/lib/model/DiscoverModel.ts"],"names":[],"mappings":"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","sourcesContent":["import bcfetch, { Album, DiscoverParams, DiscoverResult } from 'bandcamp-fetch';\nimport bandcamp from '../BandcampContext';\nimport BaseModel, { LoopFetchCallbackParams, LoopFetchResult } from './BaseModel';\nimport AlbumEntity from '../entities/AlbumEntity';\nimport EntityConverter from '../util/EntityConverter';\n\nexport interface DiscoveryModelGetDiscoverResultParams {\n  discoverParams: DiscoverParams;\n  pageToken?: string;\n  pageOffset?: number;\n  limit: number;\n}\n\ninterface GetDiscoverResultLoopFetchCallbackParams extends LoopFetchCallbackParams {\n  discoverParams: DiscoverParams;\n}\n\nexport interface DiscoverLoopFetchResult extends LoopFetchResult<AlbumEntity> {\n  params: DiscoverParams;\n}\n\nexport default class DiscoverModel extends BaseModel {\n\n  getDiscoverResult(params: DiscoveryModelGetDiscoverResultParams) {\n    return this.loopFetch({\n      callbackParams: { ...params },\n      getFetchPromise: this.#getDiscoverResultFetchPromise.bind(this),\n      getItemsFromFetchResult: this.#getDiscoverItemsFromFetchResult.bind(this),\n      getNextPageTokenFromFetchResult: this.#getNextPageTokenFromDiscoverFetchResult.bind(this),\n      convertToEntity: this.#convertFetchedDiscoverItemToEntity.bind(this),\n      onEnd: this.#onDiscoverLoopFetchEnd.bind(this),\n      pageOffset: params.pageOffset,\n      pageToken: params.pageToken,\n      limit: params.limit\n    });\n  }\n\n  #getDiscoverResultFetchPromise(params: GetDiscoverResultLoopFetchCallbackParams) {\n    let page = 0;\n    if (params.pageToken) {\n      const parsedPageToken = JSON.parse(params.pageToken);\n      page = parsedPageToken?.page || 0;\n    }\n\n    const queryParams: DiscoverParams = {\n      ...params.discoverParams,\n      page,\n      albumImageFormat: this.getAlbumImageFormat(),\n      artistImageFormat: this.getArtistImageFormat()\n    };\n\n    return bandcamp.getCache().getOrSet(\n      this.getCacheKeyForFetch('discover', queryParams),\n      () => bcfetch.limiter.discovery.discover(queryParams));\n  }\n\n  #getDiscoverItemsFromFetchResult(result: DiscoverResult) {\n    return result.items.slice(0);\n  }\n\n  #getNextPageTokenFromDiscoverFetchResult(result: DiscoverResult, params: GetDiscoverResultLoopFetchCallbackParams) {\n    let page = 0, indexRef = 0;\n    if (params.pageToken) {\n      const parsedPageToken = JSON.parse(params.pageToken);\n      page = parsedPageToken?.page || 0;\n      indexRef = parsedPageToken?.indexRef || 0;\n    }\n    if (result.items.length > 0 && result.total > indexRef + result.items.length) {\n      const nextPageToken = {\n        page: page + 1,\n        indexRef: indexRef + result.items.length\n      };\n      return JSON.stringify(nextPageToken);\n    }\n\n    return null;\n  }\n\n  #convertFetchedDiscoverItemToEntity(item: Album): AlbumEntity {\n    return EntityConverter.convertAlbum(item);\n  }\n\n  #onDiscoverLoopFetchEnd(result: LoopFetchResult<AlbumEntity>, lastFetchResult: DiscoverResult) {\n    const r: DiscoverLoopFetchResult = {\n      ...result,\n      params: lastFetchResult.params\n    };\n    delete r.params.page;\n    return r;\n  }\n\n\n  getDiscoverOptions() {\n    return bandcamp.getCache().getOrSet(\n      this.getCacheKeyForFetch('discoverOptions'),\n      () => bcfetch.limiter.discovery.getAvailableOptions());\n  }\n}\n"]}