{"version":3,"file":"ArticleModel.js","sourceRoot":"","sources":["../../../src/lib/model/ArticleModel.ts"],"names":[],"mappings":"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","sourcesContent":["import bcfetch, { Article, ArticleAPIListParams, ArticleList, ArticleListItem } from 'bandcamp-fetch';\nimport bandcamp from '../BandcampContext';\nimport BaseModel, { LoopFetchCallbackParams } from './BaseModel';\nimport ArticleEntity from '../entities/ArticleEntity';\nimport EntityConverter from '../util/EntityConverter';\n\nexport interface ArticleModelGetArticlesParams {\n  categoryUrl?: string;\n  pageToken?: string;\n  pageOffset?: number;\n  limit: number;\n}\n\ninterface GetArticlesLoopFetchCallbackParams extends LoopFetchCallbackParams {\n  categoryUrl?: string;\n}\n\nexport default class ArticleModel extends BaseModel {\n\n  getArticles(params: ArticleModelGetArticlesParams) {\n    return this.loopFetch({\n      callbackParams: { ...params },\n      getFetchPromise: this.#getArticlesFetchPromise.bind(this),\n      getItemsFromFetchResult: this.#getArticlesFromFetchResult.bind(this),\n      getNextPageTokenFromFetchResult: this.#getNextPageTokenFromArticlesFetchResult.bind(this),\n      convertToEntity: this.#convertFetchedArticleListItemToEntity.bind(this),\n      pageOffset: params.pageOffset,\n      pageToken: params.pageToken,\n      limit: params.limit\n    });\n  }\n\n  #getArticlesFetchPromise(params: GetArticlesLoopFetchCallbackParams) {\n    let page = 1;\n    if (params.pageToken) {\n      const parsedPageToken = JSON.parse(params.pageToken);\n      page = parsedPageToken?.page || 1;\n    }\n\n    const queryParams: ArticleAPIListParams = {\n      page,\n      imageFormat: this.getAlbumImageFormat()\n    };\n    if (params.categoryUrl) {\n      queryParams.categoryUrl = params.categoryUrl;\n    }\n\n    return bandcamp.getCache().getOrSet(\n      this.getCacheKeyForFetch('articles', queryParams),\n      () => bcfetch.limiter.article.list(queryParams));\n  }\n\n  #getArticlesFromFetchResult(result: ArticleList) {\n    return result.articles.slice(0);\n  }\n\n  #getNextPageTokenFromArticlesFetchResult(result: ArticleList, params: GetArticlesLoopFetchCallbackParams) {\n    let page = 1, indexRef = 0;\n    if (params.pageToken) {\n      const parsedPageToken = JSON.parse(params.pageToken);\n      page = parsedPageToken?.page || 1;\n      indexRef = parsedPageToken?.indexRef || 0;\n    }\n    if (result.articles.length > 0 && result.total > indexRef + result.articles.length) {\n      const nextPageToken = {\n        page: page + 1,\n        indexRef: indexRef + result.articles.length\n      };\n      return JSON.stringify(nextPageToken);\n    }\n\n    return null;\n\n  }\n\n  #convertFetchedArticleListItemToEntity(item: ArticleListItem): ArticleEntity {\n    return EntityConverter.convertArticleListItem(item);\n  }\n\n  async getArticle(articleUrl: string) {\n    const queryParams = {\n      articleUrl,\n      albumImageFormat: this.getAlbumImageFormat(),\n      artistImageFormat: this.getArtistImageFormat()\n    };\n    const article = await bandcamp.getCache().getOrSet(\n      this.getCacheKeyForFetch('article', queryParams),\n      () => bcfetch.limiter.article.getArticle(queryParams));\n\n    return this.#convertFetchedArticleToEntity(article);\n  }\n\n  getArticleCategories() {\n    return bandcamp.getCache().getOrSet(\n      this.getCacheKeyForFetch('articleCategories'),\n      () => bcfetch.limiter.article.getCategories());\n  }\n\n  #convertFetchedArticleToEntity(item: Article): ArticleEntity {\n    return EntityConverter.convertArticle(item);\n  }\n}\n"]}