{"version":3,"file":"SearchController.js","sourceRoot":"","sources":["../../../../src/lib/controller/search/SearchController.ts"],"names":[],"mappings":";;;;;;;;;;;AAAA,gFAAyC;AAMzC,oGAA4E;AAC5E,oFAA4D;AAM5D,MAAqB,gBAAgB;IAArC;;IA+FA,CAAC;IA7FC,KAAK,CAAC,MAAM,CAAC,KAAkB;QAC7B,MAAM,SAAS,GAAG,KAAK,CAAC,KAAK,CAAC,OAAO,CAAC,IAAI,EAAE,KAAK,CAAC,CAAC;QACnD,MAAM,QAAQ,GAAa;YACzB,IAAI,EAAE,OAAO;YACb,MAAM,EAAE,SAAS;YACjB,cAAc,EAAE,GAAG;YACnB,KAAK,EAAE,IAAI,CAAC,OAAO,CAAC,2BAAE,CAAC,OAAO,CAAC,sCAAsC,EAAE,KAAK,CAAC,KAAK,CAAC,CAAC;SACrF,CAAC;QACF,MAAM,cAAc,GAAG,cAAc,oBAAU,CAAC,2BAA2B,CAAC,QAAQ,EAAE,IAAI,CAAC,EAAE,CAAC;QAC9F,MAAM,SAAS,GAAc;YAC3B,IAAI,EAAE,QAAQ;YACd,MAAM,EAAE,SAAS;YACjB,cAAc,EAAE,GAAG;YACnB,KAAK,EAAE,IAAI,CAAC,OAAO,CAAC,2BAAE,CAAC,OAAO,CAAC,uCAAuC,EAAE,KAAK,CAAC,KAAK,CAAC,CAAC;SACtF,CAAC;QACF,MAAM,eAAe,GAAG,cAAc,oBAAU,CAAC,2BAA2B,CAAC,SAAS,EAAE,IAAI,CAAC,EAAE,CAAC;QAChG,MAAM,YAAY,GAAiB;YACjC,IAAI,EAAE,WAAW;YACjB,MAAM,EAAE,SAAS;YACjB,cAAc,EAAE,GAAG;YACnB,KAAK,EAAE,IAAI,CAAC,OAAO,CAAC,2BAAE,CAAC,OAAO,CAAC,0CAA0C,EAAE,KAAK,CAAC,KAAK,CAAC,CAAC;SACzF,CAAC;QACF,MAAM,kBAAkB,GAAG,cAAc,oBAAU,CAAC,2BAA2B,CAAC,YAAY,EAAE,IAAI,CAAC,EAAE,CAAC;QACtG,MAAM,SAAS,GAAc;YAC3B,IAAI,EAAE,QAAQ;YACd,MAAM,EAAE,SAAS;YACjB,cAAc,EAAE,GAAG;YACnB,KAAK,EAAE,IAAI,CAAC,OAAO,CAAC,2BAAE,CAAC,OAAO,CAAC,uCAAuC,EAAE,KAAK,CAAC,KAAK,CAAC,CAAC;SACtF,CAAC;QACF,MAAM,eAAe,GAAG,cAAc,oBAAU,CAAC,2BAA2B,CAAC,SAAS,EAAE,IAAI,CAAC,EAAE,CAAC;QAEhG,MAAM,QAAQ,GAAG;YACf,uBAAA,IAAI,+DAAU,MAAd,IAAI,EAAW,cAAc,EAAE,OAAO,CAAC;YACvC,uBAAA,IAAI,+DAAU,MAAd,IAAI,EAAW,eAAe,EAAE,QAAQ,CAAC;YACzC,uBAAA,IAAI,+DAAU,MAAd,IAAI,EAAW,kBAAkB,EAAE,WAAW,CAAC;YAC/C,uBAAA,IAAI,+DAAU,MAAd,IAAI,EAAW,eAAe,EAAE,QAAQ,CAAC;SAC1C,CAAC;QAEF,MAAM,aAAa,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;QAClD,MAAM,KAAK,GAAG,aAAa,CAAC,MAAM,CAAiB,CAAC,MAAM,EAAE,EAAE,EAAE,EAAE;YAChE,IAAI,CAAC,EAAE,EAAE;gBACP,OAAO,MAAM,CAAC;aACf;YACD,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,GAAG,EAAE,CAAC;YAC1B,QAAQ,IAAI,EAAE;gBACZ,KAAK,OAAO;oBACV,IAAI,CAAC,KAAK,GAAG,2BAAE,CAAC,OAAO,CAAC,4CAA4C,CAAC,CAAC;oBACtE,MAAM;gBACR,KAAK,QAAQ;oBACX,IAAI,CAAC,KAAK,GAAG,2BAAE,CAAC,OAAO,CAAC,6CAA6C,CAAC,CAAC;oBACvE,MAAM;gBACR,KAAK,WAAW;oBACd,IAAI,CAAC,KAAK,GAAG,2BAAE,CAAC,OAAO,CAAC,gDAAgD,CAAC,CAAC;oBAC1E,MAAM;gBACR,KAAK,QAAQ;oBACX,IAAI,CAAC,KAAK,GAAG,2BAAE,CAAC,OAAO,CAAC,6CAA6C,CAAC,CAAC;oBACvE,MAAM;gBACR;oBACE,IAAI,CAAC,KAAK,GAAG,YAAY,CAAC;aAC7B;YACD,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YACtC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YAClB,OAAO,MAAM,CAAC;QAChB,CAAC,EAAE,EAAE,CAAC,CAAC;QAEP,OAAO,KAAK,CAAC;IACf,CAAC;IAoBD,OAAO,CAAC,CAAS;QACf,IAAI,CAAC,oBAAU,CAAC,sBAAsB,EAAE,EAAE;YACxC,OAAO,CAAC,CAAC;SACV;QACD,MAAM,IAAI,GAAG,kCAAkC,kBAAkB,CAAC,4DAA4D,CAAC,8EAA8E,CAAC;QAC9M,OAAO,IAAI,GAAG,CAAC,CAAC;IAClB,CAAC;CACF;AA/FD,mCA+FC;0EAzBC,KAAK,qCAAW,GAAW,EAAE,IAAiD;IAC5E,IAAI;QACF,MAAM,IAAI,GAAG,MAAM,4BAAkB,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC,MAAM,EAAE,CAAC;QAC/D,MAAM,IAAI,GAAG,IAAI,CAAC,UAAU,EAAE,KAAK,EAAE,CAAC,CAAC,CAAC,CAAC;QACzC,IAAI,IAAI,IAAI,IAAI,CAAC,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE;YACjC,OAAO;gBACL,IAAI;gBACJ,IAAI;aACL,CAAC;SACH;QACD,OAAO,IAAI,CAAC;KACb;IACD,OAAO,KAAU,EAAE;QACjB,2BAAE,CAAC,SAAS,EAAE,CAAC,KAAK,CAAC,2BAAE,CAAC,eAAe,CAAC,4BAA4B,EAAE,KAAK,EAAE,IAAI,CAAC,CAAC,CAAC;QACpF,OAAO,IAAI,CAAC;KACb;AACH,CAAC","sourcesContent":["import sc from '../../SoundCloudContext';\nimport { AlbumView } from '../browse/view-handlers/AlbumViewHandler';\nimport { PlaylistView } from '../browse/view-handlers/PlaylistViewHandler';\nimport { TrackView } from '../browse/view-handlers/TrackViewHandler';\nimport { UserView } from '../browse/view-handlers/UserViewHandler';\nimport { RenderedList } from '../browse/view-handlers/ViewHandler';\nimport ViewHandlerFactory from '../browse/view-handlers/ViewHandlerFactory';\nimport ViewHelper from '../browse/view-handlers/ViewHelper';\n\nexport interface SearchQuery {\n  value: string;\n}\n\nexport default class SearchController {\n\n  async search(query: SearchQuery) {\n    const safeQuery = query.value.replace(/\"/g, '\\\\\"');\n    const userView: UserView = {\n      name: 'users',\n      search: safeQuery,\n      combinedSearch: '1',\n      title: this.addIcon(sc.getI18n('SOUNDCLOUD_LIST_TITLE_USERS_MATCHING', query.value))\n    };\n    const searchUsersUri = `soundcloud/${ViewHelper.constructUriSegmentFromView(userView, true)}`;\n    const albumView: AlbumView = {\n      name: 'albums',\n      search: safeQuery,\n      combinedSearch: '1',\n      title: this.addIcon(sc.getI18n('SOUNDCLOUD_LIST_TITLE_ALBUMS_MATCHING', query.value))\n    };\n    const searchAlbumsUri = `soundcloud/${ViewHelper.constructUriSegmentFromView(albumView, true)}`;\n    const playlistView: PlaylistView = {\n      name: 'playlists',\n      search: safeQuery,\n      combinedSearch: '1',\n      title: this.addIcon(sc.getI18n('SOUNDCLOUD_LIST_TITLE_PLAYLISTS_MATCHING', query.value))\n    };\n    const searchPlaylistsUri = `soundcloud/${ViewHelper.constructUriSegmentFromView(playlistView, true)}`;\n    const trackView: TrackView = {\n      name: 'tracks',\n      search: safeQuery,\n      combinedSearch: '1',\n      title: this.addIcon(sc.getI18n('SOUNDCLOUD_LIST_TITLE_TRACKS_MATCHING', query.value))\n    };\n    const searchTracksUri = `soundcloud/${ViewHelper.constructUriSegmentFromView(trackView, true)}`;\n\n    const searches = [\n      this.#doSearch(searchUsersUri, 'users'),\n      this.#doSearch(searchAlbumsUri, 'albums'),\n      this.#doSearch(searchPlaylistsUri, 'playlists'),\n      this.#doSearch(searchTracksUri, 'tracks')\n    ];\n\n    const searchResults = await Promise.all(searches);\n    const lists = searchResults.reduce<RenderedList[]>((result, sr) => {\n      if (!sr) {\n        return result;\n      }\n      const { list, type } = sr;\n      switch (type) {\n        case 'users':\n          list.title = sc.getI18n('SOUNDCLOUD_LIST_TITLE_SEARCH_RESULTS_USERS');\n          break;\n        case 'albums':\n          list.title = sc.getI18n('SOUNDCLOUD_LIST_TITLE_SEARCH_RESULTS_ALBUMS');\n          break;\n        case 'playlists':\n          list.title = sc.getI18n('SOUNDCLOUD_LIST_TITLE_SEARCH_RESULTS_PLAYLISTS');\n          break;\n        case 'tracks':\n          list.title = sc.getI18n('SOUNDCLOUD_LIST_TITLE_SEARCH_RESULTS_TRACKS');\n          break;\n        default:\n          list.title = 'SoundCloud';\n      }\n      list.title = this.addIcon(list.title);\n      result.push(list);\n      return result;\n    }, []);\n\n    return lists;\n  }\n\n  async #doSearch(uri: string, type: 'users' | 'albums' | 'playlists' | 'tracks') {\n    try {\n      const page = await ViewHandlerFactory.getHandler(uri).browse();\n      const list = page.navigation?.lists?.[0];\n      if (list && list.items.length > 0) {\n        return {\n          list,\n          type\n        };\n      }\n      return null;\n    }\n    catch (error: any) {\n      sc.getLogger().error(sc.getErrorMessage('[soundcloud] Search error:', error, true));\n      return null;\n    }\n  }\n\n  addIcon(s: string) {\n    if (!ViewHelper.supportsEnhancedTitles()) {\n      return s;\n    }\n    const icon = `<img src=\"/albumart?sourceicon=${encodeURIComponent('music_service/soundcloud/dist/assets/images/soundcloud.svg')}\" style=\"width: 23px; height: 23px; margin-right: 8px; margin-top: -3px;\" />`;\n    return icon + s;\n  }\n}\n"]}