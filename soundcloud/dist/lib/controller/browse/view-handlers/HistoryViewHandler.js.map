{"version":3,"file":"HistoryViewHandler.js","sourceRoot":"","sources":["../../../../../src/lib/controller/browse/view-handlers/HistoryViewHandler.ts"],"names":[],"mappings":";;;;;;;;;;;AAAA,mFAA4C;AAI5C,0CAA2C;AAE3C,wEAAgD;AAGhD,8EAAsD;AACtD,8DAAsC;AACtC,2CAA2C;AAO3C,MAAqB,kBAAmB,SAAQ,yBAA4B;IAA5E;;;IAgFA,CAAC;IA9EC,KAAK,CAAC,MAAM;QACV,MAAM,EAAE,IAAI,EAAE,SAAS,EAAE,GAAG,IAAI,CAAC,WAAW,CAAC;QAE7C,IAAI,IAAI,EAAE;YACR,OAAO,uBAAA,IAAI,qEAAY,MAAhB,IAAI,EAAa,IAAI,EAAE,CAAC,CAAC,SAAS,CAAC,CAAC;SAC5C;QAED,MAAM,QAAQ,GAAgB;YAC5B,IAAI,EAAE,SAAS;YACf,IAAI,EAAE,KAAK;YACX,SAAS,EAAE,GAAG;SACf,CAAC;QACF,MAAM,OAAO,GAAG,GAAG,IAAI,CAAC,GAAG,IAAI,oBAAU,CAAC,2BAA2B,CAAC,QAAQ,EAAE,IAAI,CAAC,EAAE,CAAC;QAExF,MAAM,UAAU,GAAgB;YAC9B,IAAI,EAAE,SAAS;YACf,IAAI,EAAE,OAAO;YACb,SAAS,EAAE,GAAG;SACf,CAAC;QACF,MAAM,SAAS,GAAG,GAAG,IAAI,CAAC,GAAG,IAAI,oBAAU,CAAC,2BAA2B,CAAC,UAAU,EAAE,IAAI,CAAC,EAAE,CAAC;QAE5F,MAAM,KAAK,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC;YAC9B,4BAAkB,CAAC,UAAU,CAAC,OAAO,CAAC,CAAC,MAAM,EAAE;YAC/C,4BAAkB,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC,MAAM,EAAE;SAClD,CAAC,CAAC;QAEH,OAAO;YACL,UAAU,EAAE;gBACV,IAAI,EAAE,EAAE,GAAG,EAAE,IAAI,CAAC,gBAAgB,EAAE,EAAE;gBACtC,KAAK,EAAE;oBACL,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,UAAU,EAAE,KAAK,IAAI,EAAE,CAAC;oBACrC,GAAG,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,UAAU,EAAE,KAAK,IAAI,EAAE,CAAC;iBACtC;aACF;SACF,CAAC;IACJ,CAAC;CA2CF;AAhFD,qCAgFC;gFAzCC,KAAK,yCAAa,IAAqB,EAAE,SAAkB;IACzD,MAAM,EAAE,OAAO,EAAE,GAAG,IAAI,CAAC,WAAW,CAAC;IACrC,MAAM,SAAS,GAAG,OAAO,EAAE,SAAS,CAAC;IACrC,MAAM,UAAU,GAAG,OAAO,EAAE,UAAU,CAAC;IACvC,MAAM,WAAW,GAA0C,EAAE,IAAI,EAAE,CAAC;IAEpE,IAAI,SAAS,EAAE;QACb,WAAW,CAAC,SAAS,GAAG,OAAO,CAAC,SAAS,CAAC;KAC3C;IACD,IAAI,UAAU,EAAE;QACd,WAAW,CAAC,UAAU,GAAG,OAAO,CAAC,UAAU,CAAC;KAC7C;IAED,IAAI,SAAS,EAAE;QACb,WAAW,CAAC,KAAK,GAAG,2BAAE,CAAC,cAAc,CAAC,iBAAiB,CAAC,CAAC;KAC1D;SACI;QACH,WAAW,CAAC,KAAK,GAAG,2BAAE,CAAC,cAAc,CAAC,cAAc,CAAC,CAAC;KACvD;IAED,MAAM,KAAK,GAAG,MAAM,IAAI,CAAC,QAAQ,CAAC,iBAAS,CAAC,OAAO,CAAC,CAAC,cAAc,CAAC,WAAW,CAAC,CAAC;IACjF,MAAM,IAAI,GAAG,IAAI,CAAC,4BAA4B,CAAC,KAAK,EAAE;QACpD,WAAW,EAAE,uBAAA,IAAI,sEAAa,CAAC,IAAI,CAAC,IAAI,CAAC;QACzC,KAAK,EAAE,IAAI,KAAK,OAAO,CAAC,CAAC,CAAC,2BAAE,CAAC,OAAO,CAAC,8CAA8C,CAAC,CAAC,CAAC,CAAC,2BAAE,CAAC,OAAO,CAAC,uCAAuC,CAAC;KAC3I,CAAC,CAAC;IAEH,OAAO,IAAI,CAAC;AACd,CAAC,6EAEY,IAAgD;IAC3D,IAAI,IAAI,CAAC,IAAI,KAAK,OAAO,EAAE;QACzB,OAAO,IAAI,CAAC,WAAW,CAAC,wBAAY,CAAC,KAAK,CAAC,CAAC;KAC7C;SACI,IAAI,IAAI,CAAC,IAAI,KAAK,UAAU,IAAI,IAAI,CAAC,IAAI,KAAK,iBAAiB,EAAE;QACpE,OAAO,IAAI,CAAC,WAAW,CAAC,wBAAY,CAAC,QAAQ,CAAC,CAAC;KAChD;SACI,IAAI,IAAI,CAAC,IAAI,KAAK,OAAO,EAAE;QAC9B,OAAO,IAAI,CAAC,WAAW,CAAC,wBAAY,CAAC,KAAK,CAAC,CAAC;KAC7C;IACD,OAAO,IAAI,CAAC;AACd,CAAC","sourcesContent":["import sc from '../../../SoundCloudContext';\nimport AlbumEntity from '../../../entities/AlbumEntity';\nimport PlaylistEntity from '../../../entities/PlaylistEntity';\nimport TrackEntity from '../../../entities/TrackEntity';\nimport { ModelType } from '../../../model';\nimport { HistoryModelGetPlayHistoryItemsParams } from '../../../model/HistoryModel';\nimport BaseViewHandler from './BaseViewHandler';\nimport View from './View';\nimport { RenderedPage } from './ViewHandler';\nimport ViewHandlerFactory from './ViewHandlerFactory';\nimport ViewHelper from './ViewHelper';\nimport { RendererType } from './renderers';\n\nexport interface HistoryView extends View {\n  name: 'history';\n  type?: 'set' | 'track';\n}\n\nexport default class HistoryViewHandler extends BaseViewHandler<HistoryView> {\n\n  async browse(): Promise<RenderedPage> {\n    const { type, inSection } = this.currentView;\n\n    if (type) {\n      return this.#browseType(type, !!inSection);\n    }\n\n    const setsView: HistoryView = {\n      name: 'history',\n      type: 'set',\n      inSection: '1'\n    };\n    const setsUri = `${this.uri}/${ViewHelper.constructUriSegmentFromView(setsView, true)}`;\n\n    const tracksView: HistoryView = {\n      name: 'history',\n      type: 'track',\n      inSection: '1'\n    };\n    const tracksUri = `${this.uri}/${ViewHelper.constructUriSegmentFromView(tracksView, true)}`;\n\n    const pages = await Promise.all([\n      ViewHandlerFactory.getHandler(setsUri).browse(),\n      ViewHandlerFactory.getHandler(tracksUri).browse()\n    ]);\n\n    return {\n      navigation: {\n        prev: { uri: this.constructPrevUri() },\n        lists: [\n          ...(pages[0].navigation?.lists || []),\n          ...(pages[1].navigation?.lists || [])\n        ]\n      }\n    };\n  }\n\n  async #browseType(type: 'set' | 'track', inSection: boolean) {\n    const { pageRef } = this.currentView;\n    const pageToken = pageRef?.pageToken;\n    const pageOffset = pageRef?.pageOffset;\n    const modelParams: HistoryModelGetPlayHistoryItemsParams = { type };\n\n    if (pageToken) {\n      modelParams.pageToken = pageRef.pageToken;\n    }\n    if (pageOffset) {\n      modelParams.pageOffset = pageRef.pageOffset;\n    }\n\n    if (inSection) {\n      modelParams.limit = sc.getConfigValue('itemsPerSection');\n    }\n    else {\n      modelParams.limit = sc.getConfigValue('itemsPerPage');\n    }\n\n    const items = await this.getModel(ModelType.History).getPlayHistory(modelParams);\n    const page = this.buildPageFromLoopFetchResult(items, {\n      getRenderer: this.#getRenderer.bind(this),\n      title: type === 'track' ? sc.getI18n('SOUNDCLOUD_LIST_TITLE_RECENTLY_PLAYED_TRACKS') : sc.getI18n('SOUNDCLOUD_LIST_TITLE_RECENTLY_PLAYED')\n    });\n\n    return page;\n  }\n\n  #getRenderer(item: AlbumEntity | PlaylistEntity | TrackEntity) {\n    if (item.type === 'album') {\n      return this.getRenderer(RendererType.Album);\n    }\n    else if (item.type === 'playlist' || item.type === 'system-playlist') {\n      return this.getRenderer(RendererType.Playlist);\n    }\n    else if (item.type === 'track') {\n      return this.getRenderer(RendererType.Track);\n    }\n    return null;\n  }\n}\n"]}