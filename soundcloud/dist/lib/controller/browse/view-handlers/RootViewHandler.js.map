{"version":3,"file":"RootViewHandler.js","sourceRoot":"","sources":["../../../../../src/lib/controller/browse/view-handlers/RootViewHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import sc from '../../../SoundCloudContext';\nimport SelectionEntity from '../../../entities/SelectionEntity';\nimport { ModelType } from '../../../model';\nimport BaseViewHandler from './BaseViewHandler';\nimport { HistoryView } from './HistoryViewHandler';\nimport { LibraryView } from './LibraryViewHandler';\nimport { SelectionView } from './SelectionViewHandler';\nimport { TrackView } from './TrackViewHandler';\nimport { UserView } from './UserViewHandler';\nimport View from './View';\nimport { RenderedList, RenderedPage } from './ViewHandler';\nimport ViewHandlerFactory from './ViewHandlerFactory';\nimport ViewHelper from './ViewHelper';\nimport { RendererType } from './renderers';\nimport { RenderedListItem } from './renderers/BaseRenderer';\n\nexport type RootView = View;\n\nexport default class RootViewHandler extends BaseViewHandler<RootView> {\n\n  async browse(): Promise<RenderedPage> {\n    const fetches = [\n      this.#getMe(),\n      this.#getTopFeaturedTracks(),\n      this.#getMixedSelections()\n    ];\n\n    const fetchResults = await Promise.all(fetches);\n    const lists = fetchResults.reduce<RenderedList[]>((result, list) => {\n      result.push(...list);\n      return result;\n    }, []);\n\n    return {\n      navigation: {\n        prev: { uri: '/' },\n        lists\n      }\n    };\n  }\n\n  async #getMe(): Promise<RenderedList[]> {\n    let myProfile;\n    try {\n      myProfile = await this.getModel(ModelType.Me).getMyProfile();\n    }\n    catch (error: any) {\n      sc.toast('error', sc.getErrorMessage('', error, false));\n      return [];\n    }\n    if (myProfile?.id) {\n      const historyView: HistoryView = {\n        name: 'history'\n      };\n      const historyItem: RenderedListItem = {\n        service: 'soundcloud',\n        type: 'item-no-menu',\n        title: sc.getI18n('SOUNDCLOUD_HISTORY'),\n        icon: 'fa fa-history',\n        uri: `${this.uri}/${ViewHelper.constructUriSegmentFromView(historyView)}`\n      };\n\n      const trackView: TrackView = {\n        name: 'track',\n        myLikes: '1'\n      };\n      const likesItem: RenderedListItem = {\n        service: 'soundcloud',\n        type: 'item-no-menu',\n        title: sc.getI18n('SOUNDCLOUD_LIKES'),\n        icon: 'fa fa-heart',\n        uri: `${this.uri}/${ViewHelper.constructUriSegmentFromView(trackView)}`\n      };\n\n      const libraryView: LibraryView = {\n        name: 'library',\n        type: 'playlist'\n      };\n      const libraryPlaylistsItem: RenderedListItem = {\n        service: 'soundcloud',\n        type: 'item-no-menu',\n        title: sc.getI18n('SOUNDCLOUD_PLAYLISTS'),\n        icon: 'fa fa-list',\n        uri: `${this.uri}/${ViewHelper.constructUriSegmentFromView(libraryView)}`\n      };\n      libraryView.type = 'album';\n      const libraryAlbumsItem: RenderedListItem = {\n        service: 'soundcloud',\n        type: 'item-no-menu',\n        title: sc.getI18n('SOUNDCLOUD_ALBUMS'),\n        icon: 'fa fa-music',\n        uri: `${this.uri}/${ViewHelper.constructUriSegmentFromView(libraryView)}`\n      };\n      libraryView.type = 'station';\n      const libraryStationsItem: RenderedListItem = {\n        service: 'soundcloud',\n        type: 'item-no-menu',\n        title: sc.getI18n('SOUNDCLOUD_STATIONS'),\n        icon: 'fa fa-microphone',\n        uri: `${this.uri}/${ViewHelper.constructUriSegmentFromView(libraryView)}`\n      };\n\n      const userView: UserView = {\n        name: 'users',\n        myFollowing: '1'\n      };\n      const followingItem: RenderedListItem = {\n        service: 'soundcloud',\n        type: 'item-no-menu',\n        title: sc.getI18n('SOUNDCLOUD_FOLLOWING'),\n        icon: 'fa fa-users',\n        uri: `${this.uri}/${ViewHelper.constructUriSegmentFromView(userView)}`\n      };\n\n      const meName = myProfile.firstName || myProfile.lastName || myProfile.username;\n      const list: RenderedList = {\n        title: sc.getI18n('SOUNDCLOUD_LIST_TITLE_WELCOME', meName),\n        items: [ historyItem, likesItem, libraryPlaylistsItem, libraryAlbumsItem, libraryStationsItem, followingItem ],\n        availableListViews: [ 'grid', 'list' ]\n      };\n\n      if (ViewHelper.supportsEnhancedTitles()) {\n        list.title = `\n          <div style=\"display: flex; flex-direction: column; height: 48px; padding: 1px 0;\">\n            <div style=\"flex-grow: 1;\">${list.title}</div>\n            <div><a target=\"_blank\" style=\"color: #50b37d; font-size: 14px;\" href=\"https://soundcloud.com/${myProfile.username}\">${sc.getI18n('SOUNDCLOUD_VIEW_MY_PAGE')}</a></div>\n          </div>`;\n\n        if (myProfile.thumbnail) {\n          list.title = `<img src=\"${myProfile.thumbnail}\" style=\"border-radius: 50%; width: 48px; height: 48px; margin-right: 12px;\" /> ${list.title}`;\n        }\n\n        list.title = `\n          <div style=\"width: 100%; padding-bottom: 12px; border-bottom: 1px solid; display: flex; align-items: center;\">\n              ${list.title}\n          </div>\n        `;\n      }\n\n      return [ list ];\n    }\n    return [];\n  }\n\n  async #getTopFeaturedTracks(): Promise<RenderedList[]> {\n    try {\n      const trackView: TrackView = {\n        name: 'tracks',\n        topFeatured: '1',\n        inSection: '1',\n        title: sc.getI18n('SOUNDCLOUD_LIST_TITLE_TOP_FEATURED_TRACKS')\n      };\n      const tracksUri = `${this.uri}/${ViewHelper.constructUriSegmentFromView(trackView, true)}`;\n      const page = await ViewHandlerFactory.getHandler(tracksUri).browse();\n      const list = page.navigation?.lists?.[0];\n      if (list && list.items.length > 0) {\n        if (ViewHelper.supportsEnhancedTitles()) {\n          list.title = `\n          <div style=\"width: 100%;\">\n              <div style=\"padding-bottom: 8px; border-bottom: 1px solid;\">\n                  ${list.title}\n              </div>\n          </div>`;\n        }\n        return [ list ];\n      }\n      return [];\n    }\n    catch (error: any) {\n      sc.getLogger().error(sc.getErrorMessage('[soundcloud] Failed to get top featured tracks in root view:', error, true));\n      return [];\n    }\n  }\n\n  async #getMixedSelections(): Promise<RenderedList[]> {\n    try {\n      const selections = await this.getModel(ModelType.Selection).getSelections({ mixed: true });\n      const lists = selections.items.reduce<RenderedList[]>((result, selection, index) => {\n        if (selection.items.length > 0) {\n          result.push(this.#getListFromSelection(selection, index));\n        }\n        return result;\n      }, []);\n      return lists;\n    }\n    catch (error: any) {\n      sc.getLogger().error(sc.getErrorMessage('[soundcloud] Failed to get selections in root view:', error, true));\n      return [];\n    }\n  }\n\n  #getListFromSelection(selection: SelectionEntity, index: number): RenderedList {\n    const limit = sc.getConfigValue('itemsPerSection');\n    const slice = selection.items.slice(0, limit);\n    const renderer = this.getRenderer(RendererType.Playlist);\n    const listItems = slice.reduce<RenderedListItem[]>((result, item) => {\n      const rendered = renderer.renderToListItem(item);\n      if (rendered) {\n        result.push(rendered);\n      }\n      return result;\n    }, []);\n    if (selection.id && limit < selection.items.length) {\n      const nextPageRef = this.constructPageRef(limit.toString(), 0);\n      if (nextPageRef) {\n        const selectionView: SelectionView = {\n          name: 'selections',\n          selectionId: selection.id,\n          pageRef: nextPageRef\n        };\n        const nextUri = `${this.uri}/${ViewHelper.constructUriSegmentFromView(selectionView)}`;\n        listItems.push(this.constructNextPageItem(nextUri));\n      }\n    }\n    let listTitle;\n    if (selection.title) {\n      if (!ViewHelper.supportsEnhancedTitles()) {\n        listTitle = selection.title;\n      }\n      else if (index === 0) {\n        listTitle = `\n              <div style=\"width: 100%;\">\n                  <div style=\"padding-bottom: 8px; border-bottom: 1px solid; margin-bottom: 24px;\">\n                      ${sc.getI18n('SOUNDCLOUD_TRENDING_PLAYLISTS')}\n                  </div>\n                  <span style=\"font-size: 16px; color: #bdbdbd;\">${selection.title}</span>\n              </div>`;\n      }\n      else {\n        listTitle = `<span style=\"font-size: 16px; color: #bdbdbd;\">${selection.title}</span>`;\n      }\n    }\n    else {\n      listTitle = sc.getI18n('SOUNDCLOUD_TRENDING_PLAYLISTS');\n    }\n    return {\n      title: listTitle,\n      availableListViews: [ 'list', 'grid' ],\n      items: listItems\n    };\n  }\n}\n"]}