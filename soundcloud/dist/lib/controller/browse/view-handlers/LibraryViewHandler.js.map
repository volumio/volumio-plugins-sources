{"version":3,"file":"LibraryViewHandler.js","sourceRoot":"","sources":["../../../../../src/lib/controller/browse/view-handlers/LibraryViewHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import sc from '../../../SoundCloudContext';\nimport AlbumEntity from '../../../entities/AlbumEntity';\nimport PlaylistEntity from '../../../entities/PlaylistEntity';\nimport { ModelType } from '../../../model';\nimport { MeModelGetLibraryItemsParams } from '../../../model/MeModel';\nimport BaseViewHandler from './BaseViewHandler';\nimport View from './View';\nimport { RenderedList, RenderedPage } from './ViewHandler';\nimport ViewHelper from './ViewHelper';\nimport { RendererType } from './renderers';\nimport { RenderedListItem } from './renderers/BaseRenderer';\n\nexport interface LibraryView extends View {\n  name: 'library';\n  type: 'album' | 'playlist' | 'station';\n  filter?: 'liked' | 'created' | 'all'; // Only for 'album' and 'playlist' types\n  selectFilter?: '1';\n}\n\nexport default class LibraryViewHandler extends BaseViewHandler<LibraryView> {\n\n  async browse(): Promise<RenderedPage> {\n    const { type, pageRef, filter = 'all', selectFilter = false } = this.currentView;\n\n    if (selectFilter && (type === 'album' || type === 'playlist')) {\n      return this.#browseFilters();\n    }\n\n    const pageToken = pageRef?.pageToken;\n    const pageOffset = pageRef?.pageOffset;\n    const modelParams: MeModelGetLibraryItemsParams = {\n      type,\n      limit: sc.getConfigValue('itemsPerPage'),\n      filter\n    };\n\n    if (pageToken) {\n      modelParams.pageToken = pageRef.pageToken;\n    }\n    if (pageOffset) {\n      modelParams.pageOffset = pageRef.pageOffset;\n    }\n\n    const items = await this.getModel(ModelType.Me).getLibraryItems(modelParams);\n    const page = this.buildPageFromLoopFetchResult(items, {\n      render: this.#renderToListItem.bind(this)\n    });\n\n    // Filter\n    const filterOptions = this.#getFilterOptions();\n    const browseFilterView: LibraryView = {\n      ...this.currentView,\n      selectFilter: '1'\n    };\n    const browseFilterUri = ViewHelper.constructUriFromViews([\n      ...this.previousViews,\n      browseFilterView\n    ]);\n    const filterListItem: RenderedListItem = {\n      service: 'soundcloud',\n      type: 'item-no-menu',\n      title: filterOptions.find((option) => option.value === filter)?.label || sc.getI18n('SOUNDCLOUD_FILTER_ALL'),\n      icon: 'fa fa-filter',\n      uri: browseFilterUri\n    };\n    const filterList: RenderedList = {\n      title: this.#getTitle(),\n      items: [ filterListItem ],\n      availableListViews: [ 'list' ]\n    };\n    if (page.navigation?.lists) {\n      page.navigation.lists.unshift(filterList);\n    }\n\n    return page;\n  }\n\n  #renderToListItem(item: AlbumEntity | PlaylistEntity) {\n    if (item.type === 'album') {\n      return this.getRenderer(RendererType.Album).renderToListItem(item, true);\n    }\n    else if (item.type === 'playlist' || item.type === 'system-playlist') {\n      return this.getRenderer(RendererType.Playlist).renderToListItem(item, true);\n    }\n    return null;\n  }\n\n  #getTitle() {\n    const { type } = this.currentView;\n    if (type === 'album') {\n      return sc.getI18n('SOUNDCLOUD_ALBUMS');\n    }\n    else if (type === 'playlist') {\n      return sc.getI18n('SOUNDCLOUD_PLAYLISTS');\n    }\n    else if (type === 'station') {\n      return sc.getI18n('SOUNDCLOUD_STATIONS');\n    }\n    return undefined;\n  }\n\n  async #browseFilters(): Promise<RenderedPage> {\n    const view = this.currentView;\n    const { filter = 'all' } = view;\n\n    const options = this.#getFilterOptions();\n\n    const listItems = options.map<RenderedListItem>((option) => {\n      const isSelected = option.value === filter;\n      let title;\n      if (isSelected) {\n        title = `<span style='color: #54c688; font-weight: bold;'}>${option.label}</span>`;\n      }\n      else {\n        title = option.label;\n      }\n\n      const viewWithSelectedOption: LibraryView = {\n        ...this.currentView\n      };\n      if (this.currentView.filter !== option.value) {\n        delete viewWithSelectedOption.pageRef;\n        delete viewWithSelectedOption.prevPageRefs;\n        viewWithSelectedOption.filter = option.value;\n      }\n      delete viewWithSelectedOption.selectFilter;\n\n      const uriWithSelectedOption = ViewHelper.constructUriFromViews([\n        ...this.previousViews,\n        viewWithSelectedOption\n      ]);\n\n      return {\n        service: 'soundcloud',\n        type: 'item-no-menu',\n        title,\n        icon: isSelected ? 'fa fa-check' : 'fa',\n        uri: uriWithSelectedOption\n      };\n    });\n\n    const list: RenderedList = {\n      availableListViews: [ 'list' ],\n      items: listItems\n    };\n\n    return {\n      navigation: {\n        prev: { uri: this.constructPrevUri() },\n        lists: [ list ]\n      }\n    };\n  }\n\n  #getFilterOptions() {\n    const options: { label: string, value: NonNullable<LibraryView['filter']> }[] = [\n      {\n        label: sc.getI18n('SOUNDCLOUD_FILTER_ALL'),\n        value: 'all'\n      },\n      {\n        label: sc.getI18n('SOUNDCLOUD_FILTER_CREATED'),\n        value: 'created'\n      },\n      {\n        label: sc.getI18n('SOUNDCLOUD_FILTER_LIKED'),\n        value: 'liked'\n      }\n    ];\n    return options;\n  }\n}\n"]}