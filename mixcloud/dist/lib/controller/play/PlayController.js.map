{"version":3,"file":"PlayController.js","sourceRoot":"","sources":["../../../../src/lib/controller/play/PlayController.ts"],"names":[],"mappings":"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","sourcesContent":["// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore\nimport libQ from 'kew';\n\nimport miniget from 'miniget';\nimport { Parser as m3u8Parser } from 'm3u8-parser';\nimport mixcloud from '../../MixcloudContext';\nimport { ExplodedTrackInfo } from '../browse/view-handlers/ExplodableViewHandler';\nimport ViewHelper from '../browse/view-handlers/ViewHelper';\nimport Model, { ModelType } from '../../model';\nimport LiveStreamProxy from './LiveStreamProxy';\nimport { kewToJSPromise } from '../../util';\n\ninterface StreamInfo {\n  url: string;\n  isHLS: boolean;\n  liveStreamProxy?: LiveStreamProxy;\n}\n\nexport default class PlayController {\n\n  #mpdPlugin: any;\n\n  constructor() {\n    this.#mpdPlugin = mixcloud.getMpdPlugin();\n  }\n\n  /**\n   * Track uri:\n   * - mixcloud/cloudcast@cloudcastId={...}@owner={...}\n   * - mixcloud/livestream@username={...}\n   */\n  async clearAddPlayTrack(track: ExplodedTrackInfo) {\n    mixcloud.getLogger().info(`[mixcloud] clearAddPlayTrack: ${track.uri}`);\n\n    let stream;\n    try {\n      stream = await this.#getStreamInfo(track);\n    }\n    catch (error: any) {\n      mixcloud.getLogger().error(`[mixcloud] Error getting stream: ${error}`);\n      throw error;\n    }\n\n    try {\n      return await kewToJSPromise(this.#doPlay(stream.url, track));\n    }\n    catch (error) {\n      if (stream.liveStreamProxy) {\n        await stream.liveStreamProxy.kill();\n      }\n      throw error;\n    }\n  }\n\n  // Returns kew promise!\n  stop() {\n    mixcloud.getStateMachine().setConsumeUpdateService('mpd', true, false);\n    return this.#mpdPlugin.stop();\n  }\n\n  // Returns kew promise!\n  pause() {\n    mixcloud.getStateMachine().setConsumeUpdateService('mpd', true, false);\n    return this.#mpdPlugin.pause();\n  }\n\n  // Returns kew promise!\n  resume() {\n    mixcloud.getStateMachine().setConsumeUpdateService('mpd', true, false);\n    return this.#mpdPlugin.resume();\n  }\n\n  // Returns kew promise!\n  seek(position: number) {\n    mixcloud.getStateMachine().setConsumeUpdateService('mpd', true, false);\n    return this.#mpdPlugin.seek(position);\n  }\n\n  // Returns kew promise!\n  next() {\n    mixcloud.getStateMachine().setConsumeUpdateService('mpd', true, false);\n    return this.#mpdPlugin.next();\n  }\n\n  // Returns kew promise!\n  previous() {\n    mixcloud.getStateMachine().setConsumeUpdateService(undefined);\n    return mixcloud.getStateMachine().previous();\n  }\n\n  async #getStreamInfo(track: ExplodedTrackInfo): Promise<StreamInfo> {\n    const views = ViewHelper.getViewsFromUri(track.uri);\n    let trackView = views[1];\n    if (!trackView) {\n      trackView = { name: '' };\n    }\n    let stream: StreamInfo | null = null;\n    if (trackView.name === 'cloudcast' && trackView.cloudcastId) {\n      const cloudcastId = trackView.cloudcastId;\n      const cloudcast = await Model.getInstance(ModelType.Cloudcast).getCloudcast(cloudcastId);\n      const streamUrl = cloudcast?.streams?.hls || cloudcast?.streams?.http || cloudcast?.streams?.dash || null;\n      if (!streamUrl) {\n        if (cloudcast?.isExclusive) {\n          mixcloud.toast('warning', mixcloud.getI18n('MIXCLOUD_SKIP_EXCLUSIVE', track.name));\n          mixcloud.getStateMachine().next();\n          throw Error('Skipping exclusive cloudcast');\n        }\n        else {\n          mixcloud.toast('error', mixcloud.getI18n('MIXCLOUD_NO_STREAM', track.name));\n          if (!cloudcast) {\n            throw Error(`Stream not found for cloudcastId: ${cloudcastId} (Cloudcast does not exist)`);\n          }\n          throw Error(`Stream not found for cloudcastId: ${cloudcastId} (URL: ${cloudcast.url})`);\n        }\n      }\n      else {\n        stream = {\n          url: streamUrl,\n          isHLS: !!cloudcast?.streams?.hls\n        };\n      }\n    }\n    else if (trackView.name === 'liveStream' && trackView.username) {\n      const username = trackView.username;\n      const liveStream = await Model.getInstance(ModelType.LiveStream).getLiveStream(username);\n      if (!liveStream || !liveStream.streams?.hls) {\n        mixcloud.toast('error', mixcloud.getI18n('MIXCLOUD_USER_NO_LIVE_STREAM', username));\n        throw Error(`Live stream not found for user ${username}`);\n      }\n      if (!liveStream.isLive) {\n        mixcloud.toast('error', mixcloud.getI18n('MIXCLOUD_LIVE_STREAM_ENDED', username));\n        throw Error(`Live stream has ended for user ${username}`);\n      }\n      const proxy = new LiveStreamProxy(liveStream.streams.hls);\n      try {\n        const proxyStreamUrl = await proxy.start();\n        stream = {\n          url: proxyStreamUrl,\n          isHLS: false,\n          liveStreamProxy: proxy\n        };\n      }\n      catch (error) {\n        mixcloud.toast('error', mixcloud.getI18n(\n          'MIXCLOUD_LIVE_STREAM_PROXY_START_ERR',\n          error instanceof Error ? error.message : error));\n\n        throw Error(`Live stream obtained for user ${username}, but failed to start live stream proxy for playback.`);\n      }\n      track.duration = 0;\n    }\n    if (stream) {\n      if (stream.isHLS) {\n        // We setConsumeUpdateService to ignore metadata, so statemachine will take sample rate and bit depth from\n        // Trackblock, which we don't have...At best, if stream is HLS, we try to obtain the max bit rate (bandwidth) and set it\n        // As the sample rate. Otherwise, statemachine will obtain the bitrate from MPD but this is not always available.\n        const bandwidth = await this.#getBandwidthFromHLS(stream.url);\n        if (bandwidth) {\n          const bitrate = `${Math.floor(bandwidth / 1000)} kbps`;\n          track.samplerate = bitrate;\n        }\n      }\n      // Safe URL\n      stream.url = stream.url.replace(/\"/g, '\\\\\"');\n\n      return stream;\n    }\n\n    mixcloud.toast('error', mixcloud.getI18n('MIXCLOUD_INVALID_TRACK_URI', track.uri));\n    throw Error(`Invalid track URI: ${track.uri}`);\n  }\n\n  // Returns kew promise!\n  #doPlay(streamUrl: string, track: ExplodedTrackInfo) {\n    const mpdPlugin = this.#mpdPlugin;\n\n    return mpdPlugin.sendMpdCommand('stop', [])\n      .then(() => {\n        return mpdPlugin.sendMpdCommand('clear', []);\n      })\n      .then(() => {\n        return mpdPlugin.sendMpdCommand(`addid \"${streamUrl}\"`, []);\n      })\n      .then((addIdResp: { Id: string }) => this.#mpdAddTags(addIdResp, track))\n      .then(() => {\n        mixcloud.getStateMachine().setConsumeUpdateService('mpd', true, false);\n        return mpdPlugin.sendMpdCommand('play', []);\n      });\n  }\n\n  // Returns kew promise!\n  #mpdAddTags(mpdAddIdResponse: { Id: string }, track: ExplodedTrackInfo) {\n    const songId = mpdAddIdResponse?.Id;\n    if (songId !== undefined) {\n      const cmds = [];\n      cmds.push({\n        command: 'addtagid',\n        parameters: [ songId, 'title', track.title ]\n      });\n      if (track.album) {\n        cmds.push({\n          command: 'addtagid',\n          parameters: [ songId, 'album', track.album ]\n        });\n      }\n      cmds.push({\n        command: 'addtagid',\n        parameters: [ songId, 'artist', track.artist ]\n      });\n\n      return this.#mpdPlugin.sendMpdCommandArray(cmds);\n    }\n    return libQ.resolve();\n  }\n\n  async #getBandwidthFromHLS(streamUrl: string) {\n    const body = await miniget(streamUrl).text();\n    const parser = new m3u8Parser();\n    parser.push(body);\n    parser.end();\n    const playlists = parser.manifest.playlists;\n    if (playlists && Array.isArray(playlists)) {\n      const attributes = playlists[0]?.attributes;\n      if (attributes && typeof attributes === 'object' && Reflect.has(attributes, 'BANDWIDTH')) {\n        const bandwidth = Reflect.get(attributes, 'BANDWIDTH');\n        return Number(bandwidth) || null;\n      }\n    }\n    return null;\n  }\n}\n"]}