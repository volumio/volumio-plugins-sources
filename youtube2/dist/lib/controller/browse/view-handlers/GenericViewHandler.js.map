{"version":3,"file":"GenericViewHandler.js","sourceRoot":"","sources":["../../../../../src/lib/controller/browse/view-handlers/GenericViewHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import yt2 from '../../../YouTube2Context';\nimport { ModelType } from '../../../model';\nimport InnertubeLoader from '../../../model/InnertubeLoader';\nimport { PageContent, WatchContent } from '../../../types/Content';\nimport Endpoint, { EndpointType, WatchEndpoint } from '../../../types/Endpoint';\nimport { AuthStatus } from '../../../util/Auth';\nimport EndpointHelper from '../../../util/EndpointHelper';\nimport ExplodeHelper from '../../../util/ExplodeHelper';\nimport FeedViewHandler, { FeedView } from './FeedViewHandler';\n\n// From InnerTube lib (YouTube.js#Actions)\nconst REQUIRES_SIGNIN_BROWSE_IDS = [\n  'FElibrary',\n  'FEhistory',\n  'FEsubscriptions',\n  'FEchannels',\n  'FEmusic_listening_review',\n  'FEmusic_library_landing',\n  'SPaccount_overview',\n  'SPaccount_notifications',\n  'SPaccount_privacy',\n  'SPtime_watched'\n];\n\nexport interface GenericView extends FeedView {\n  name: 'generic',\n}\n\n/**\n * Generic view handler. Contents fetched from endpoint with the EndpointModel.\n */\n\nexport default class GenericViewHandler<V extends Omit<GenericView, 'name'> & { name: string; } = GenericView> extends FeedViewHandler<V> {\n\n  async browse() {\n    const endpoint = this.getEndpoint();\n    const { auth } = await InnertubeLoader.getInstance();\n\n    if (EndpointHelper.isType(endpoint, EndpointType.Browse) &&\n      REQUIRES_SIGNIN_BROWSE_IDS.includes(endpoint.payload.browseId) &&\n      auth.getStatus().status !== AuthStatus.SignedIn) {\n      yt2.toast('error', yt2.getI18n('YOUTUBE2_ERR_REQUIRE_SIGN_IN'));\n      throw Error(yt2.getI18n('YOUTUBE2_ERR_REQUIRE_SIGN_IN'));\n    }\n\n    return super.browse();\n  }\n\n  protected async getContents(): Promise<PageContent> {\n    const endpoint = this.assertEndpointExists(this.getEndpoint());\n    const contents = await this.getModel(ModelType.Endpoint).getContents(endpoint);\n    return this.assertPageContents(contents);\n  }\n\n  protected assertEndpointExists(endpoint?: Endpoint | null): Endpoint {\n    if (!endpoint) {\n      yt2.toast('error', yt2.getI18n('YOUTUBE2_ERR_ENDPOINT_INVALID'));\n      throw Error(yt2.getI18n('YOUTUBE2_ERR_ENDPOINT_INVALID'));\n    }\n    return endpoint;\n  }\n\n  protected assertPageContents(content: PageContent | WatchContent | null): PageContent {\n    if (content?.type !== 'page') {\n      yt2.toast('error', yt2.getI18n('YOUTUBE2_ERR_ENDPOINT_INVALID'));\n      throw Error(`Expecting page contents, but got ${content?.type}`);\n    }\n    return content;\n  }\n\n  protected async getTracksOnExplode() {\n    const endpoint = this.getEndpoint(true);\n\n    if (!endpoint || !endpoint.payload) {\n      yt2.toast('error', yt2.getI18n('YOUTUBE2_ERR_OP_NOT_SUPPORTED'));\n      throw Error(yt2.getI18n('YOUTUBE2_ERR_OP_NOT_SUPPORTED'));\n    }\n\n    const endpointPredicate = (endpoint: Endpoint): endpoint is WatchEndpoint => !!(EndpointHelper.isType(endpoint, EndpointType.Watch) && endpoint.payload?.playlistId);\n    const model = this.getModel(ModelType.Endpoint);\n    let targetWatchEndpoint: WatchEndpoint | null = null;\n\n    if (EndpointHelper.isType(endpoint, EndpointType.Browse)) {\n      let contents = await model.getContents({...endpoint, type: endpoint.type});\n      let tabs = contents?.tabs || [];\n      if (tabs.length > 0) {\n        // Remaining tabs that can be used to look for watch endpoints\n        tabs = tabs.filter((tab) => !tab.selected && EndpointHelper.isType(tab.endpoint, EndpointType.Browse));\n      }\n      while (!targetWatchEndpoint) {\n        targetWatchEndpoint = this.findAllEndpointsInSection<WatchEndpoint>(contents?.sections, endpointPredicate)[0];\n        if (!targetWatchEndpoint) {\n          const nextTab = tabs.shift();\n          if (nextTab?.endpoint && EndpointHelper.isType(nextTab.endpoint, EndpointType.Browse)) {\n            contents = await model.getContents({...nextTab.endpoint, type: endpoint.type});\n          }\n          else {\n            break;\n          }\n        }\n      }\n    }\n    else if (endpointPredicate(endpoint)) {\n      targetWatchEndpoint = endpoint;\n    }\n\n    if (!targetWatchEndpoint) {\n      yt2.toast('error', yt2.getI18n('YOUTUBE2_ERR_NO_PLAYABLE_ITEMS_FOUND'));\n      throw Error('No playable items found');\n    }\n\n    const contents = await model.getContents(targetWatchEndpoint);\n\n    const result = contents?.playlist?.items?.filter((item) => item.type === 'video')\n      .map((item) => ExplodeHelper.getExplodedTrackInfoFromVideo(item)) || [];\n\n    return result;\n  }\n\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  protected getEndpoint(explode = false): Endpoint | null {\n    const view = this.currentView;\n    if (view.continuation) {\n      return view.continuation.endpoint;\n    }\n    return view.endpoint || null;\n  }\n}\n"]}