{"version":3,"file":"RootModel.js","sourceRoot":"","sources":["../../../src/lib/model/RootModel.ts"],"names":[],"mappings":"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","sourcesContent":["import { YTNodes, Helpers as YTHelpers } from 'volumio-youtubei.js';\nimport { BaseModel } from './BaseModel';\nimport InnertubeResultParser from './InnertubeResultParser';\nimport { ContentItem, PageElement } from '../types';\nimport EndpointHelper from '../util/EndpointHelper';\nimport { PageContent } from '../types/Content';\n\nexport default class RootModel extends BaseModel {\n\n  async getContents(opts?: { contentType: 'simple' | 'full'}): Promise<PageContent | null> {\n    const { innertube } = await this.getInnertube();\n    const guide = await innertube.getGuide();\n    const sections = guide.contents.map((section) => this.#expandGuideSection(section));\n    const parsed = InnertubeResultParser.parseResult({ contents: sections });\n\n    const primaryOnly = opts?.contentType === 'simple';\n    if (parsed) {\n      parsed.sections = parsed.sections.reduce<PageElement.Section[]>((filtered, section) => {\n        const filteredSection = this.#filterGuideEntries(section, primaryOnly);\n        if (filteredSection) {\n          filtered.push(filteredSection);\n        }\n        return filtered;\n      }, []);\n    }\n\n    return parsed;\n  }\n\n  #expandGuideSection(section: YTNodes.GuideSection | YTNodes.GuideSubscriptionsSection) {\n    const sectionItems = section.items.reduce<YTHelpers.YTNode[]>((result, entry) => {\n      result.push(...this.#expandGuideEntry(entry));\n      return result;\n    }, []);\n    const result = {\n      type: section.type,\n      title: section.title,\n      items: sectionItems\n    };\n    return result;\n  }\n\n  #expandGuideEntry(entry: YTHelpers.YTNode): YTHelpers.YTNode[] {\n    if (entry instanceof YTNodes.GuideCollapsibleEntry) {\n      const collapsibleEntry = entry as YTNodes.GuideCollapsibleEntry;\n      return collapsibleEntry.expandable_items.reduce<YTHelpers.YTNode[]>((expanded, item) => {\n        expanded.push(...this.#expandGuideEntry(item));\n        return expanded;\n      }, []);\n    }\n    if (entry instanceof YTNodes.GuideCollapsibleSectionEntry) {\n      const sectionEntry = entry as YTNodes.GuideCollapsibleSectionEntry;\n      const initialExpanded = sectionEntry.header_entry ? this.#expandGuideEntry(sectionEntry.header_entry) : [];\n      return sectionEntry.section_items.reduce<YTHelpers.YTNode[]>((expanded, item) => {\n        expanded.push(...this.#expandGuideEntry(item));\n        return expanded;\n      }, initialExpanded);\n    }\n\n    return [ entry ];\n  }\n\n  // 1. Filter out guide entries in given section with invalid endpoints\n  // 2. If no entries left in section, return `null`\n  #filterGuideEntries(section: PageElement.Section, primaryOnly = false): PageElement.Section | null {\n    const filteredItems: (PageElement.Section | ContentItem.GuideEntry)[] = [];\n\n    section.items.forEach((item) => {\n      if (item.type === 'section') {\n        const filterNestedResult = this.#filterGuideEntries(item, primaryOnly);\n        if (filterNestedResult) {\n          filteredItems.push(filterNestedResult);\n        }\n      }\n      else if ((item.type === 'guideEntry' && primaryOnly ? item.isPrimary : true) && EndpointHelper.validate(item.endpoint)) {\n        filteredItems.push(item as ContentItem.GuideEntry);\n      }\n    });\n\n    if (filteredItems.length > 0) {\n      return {\n        type: section.type,\n        title: section.title,\n        items: filteredItems\n      };\n    }\n\n    return null;\n  }\n}\n"]}