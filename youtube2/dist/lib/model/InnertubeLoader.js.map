{"version":3,"file":"InnertubeLoader.js","sourceRoot":"","sources":["../../../src/lib/model/InnertubeLoader.ts"],"names":[],"mappings":"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","sourcesContent":["import yt2 from '../YouTube2Context';\nimport Innertube from 'volumio-youtubei.js';\nimport Auth, { AuthEvent } from '../util/Auth';\n\nexport interface InnertubeLoaderGetInstanceResult {\n  innertube: Innertube;\n  auth: Auth;\n}\n\nexport default class InnertubeLoader {\n\n  static #innertube: Innertube | null = null;\n  static #auth: Auth | null = null;\n  static #pendingPromise: Promise<InnertubeLoaderGetInstanceResult> | null = null;\n\n  static async getInstance(): Promise<InnertubeLoaderGetInstanceResult> {\n    if (this.#innertube && this.#auth) {\n      return {\n        innertube: this.#innertube,\n        auth: this.#auth\n      };\n    }\n\n    if (this.#pendingPromise) {\n      return this.#pendingPromise;\n    }\n\n    this.#pendingPromise = new Promise(async (resolve) => {\n      yt2.getLogger().info('[youtube2] InnertubeLoader: creating Innertube instance...');\n      this.#innertube = await Innertube.create();\n      this.applyI18nConfig();\n\n      yt2.getLogger().info('[youtube2] InnertubeLoader: creating Auth instance...');\n      this.#auth = Auth.create(this.#innertube);\n      this.#auth.on(AuthEvent.SignIn, this.#handleAuthEvent.bind(this, AuthEvent.SignIn, this.#innertube, this.#auth, resolve));\n      this.#auth.on(AuthEvent.Pending, this.#handleAuthEvent.bind(this, AuthEvent.Pending, this.#innertube, this.#auth, resolve));\n      this.#auth.on(AuthEvent.Error, this.#handleAuthEvent.bind(this, AuthEvent.Error, this.#innertube, this.#auth, resolve));\n      this.#auth.signIn();\n    });\n\n    return this.#pendingPromise;\n  }\n\n  static reset() {\n    if (this.#pendingPromise) {\n      this.#pendingPromise = null;\n    }\n    if (this.#auth) {\n      this.#auth.dispose();\n    }\n    this.#auth = null;\n    this.#innertube = null;\n  }\n\n  static hasInstance() {\n    return this.#innertube && this.#auth;\n  }\n\n  static #handleAuthEvent(event: AuthEvent, innertube: Innertube, auth: Auth, resolve: (value: InnertubeLoaderGetInstanceResult) => void) {\n    if (!this.#pendingPromise) {\n      return;\n    }\n    let status: string;\n    switch (event) {\n      case AuthEvent.SignIn:\n        status = 'signed in';\n        break;\n      case AuthEvent.Pending:\n        status = 'pending sign-in';\n        break;\n      case AuthEvent.Error:\n        status = 'error';\n        break;\n      default:\n        status = 'undefined';\n    }\n    yt2.getLogger().info(`[youtube2] InnertubeLoader: Auth instance created (status: ${status})`);\n    this.#pendingPromise = null;\n    auth.removeAllListeners();\n    resolve({\n      innertube,\n      auth\n    });\n  }\n\n  static applyI18nConfig() {\n    if (!this.#innertube) {\n      return;\n    }\n\n    const region = yt2.getConfigValue('region');\n    const language = yt2.getConfigValue('language');\n\n    this.#innertube.session.context.client.gl = region;\n    this.#innertube.session.context.client.hl = language;\n  }\n}\n"]}