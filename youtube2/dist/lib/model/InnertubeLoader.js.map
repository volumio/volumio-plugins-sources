{"version":3,"file":"InnertubeLoader.js","sourceRoot":"","sources":["../../../src/lib/model/InnertubeLoader.ts"],"names":[],"mappings":"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","sourcesContent":["import fetch from 'node-fetch';\nimport yt2 from '../YouTube2Context';\nimport Innertube from 'volumio-youtubei.js';\nimport BG, { type BgConfig } from 'bgutils-js';\nimport { JSDOM } from 'jsdom';\nimport { getAccountInitialInfo } from './AccountModelHelper';\nimport atob from 'atob';\nimport btoa from 'btoa';\n\n// Polyfill for BGUtils\nif (globalThis && !globalThis.atob) {\n  globalThis.atob = atob;\n}\nif (globalThis && !globalThis.btoa) {\n  globalThis.btoa = btoa;\n}\n\nexport interface InnertubeLoaderGetInstanceResult {\n  innertube: Innertube;\n}\n\nenum Stage {\n  Init = '1 - Init',\n  PO = '2 - PO'\n}\n\ninterface POToken {\n  params: {\n    visitorData?: string;\n    identifier: {\n      type: 'visitorData' | 'datasyncIdToken';\n      value: string;\n      pageId?: string;\n    };\n  }\n  value: string;\n  ttl?: number;\n  refreshThreshold?: number;\n}\n\nexport default class InnertubeLoader {\n\n  static #innertube: Innertube | null = null;\n  static #pendingPromise: Promise<InnertubeLoaderGetInstanceResult> | null = null;\n  static #poTokenRefreshTimer: NodeJS.Timeout | null = null;\n\n  static async getInstance(): Promise<InnertubeLoaderGetInstanceResult> {\n    if (this.#innertube) {\n      return {\n        innertube: this.#innertube,\n      };\n    }\n\n    if (this.#pendingPromise) {\n      return this.#pendingPromise;\n    }\n\n    this.#pendingPromise = new Promise<InnertubeLoaderGetInstanceResult>((resolve, reject) => {\n      this.#createInstance(Stage.Init, resolve)\n        .catch((error: unknown) => {\n          reject(error instanceof Error ? error : Error(String(error)))\n        });\n    });\n\n    return this.#pendingPromise;\n  }\n\n  static async #recreateWithPOToken(innertube: Innertube, resolve: (value: InnertubeLoaderGetInstanceResult) => void, lastToken?: POToken) {\n    const visitorData = lastToken?.params.visitorData || innertube.session.context.client.visitorData;\n    let identifier: POToken['params']['identifier'] | null = visitorData ? {\n      type: 'visitorData',\n      value: visitorData\n    } : null;\n\n    const lastIdentifier = lastToken?.params.identifier;\n    if (lastIdentifier) {\n      identifier = lastIdentifier;\n    }\n    else {\n      const account = await getAccountInitialInfo(innertube);\n      if (account.isSignedIn) {\n        const activeChannelHandle = yt2.getConfigValue('activeChannelHandle');\n        let target;\n        if (activeChannelHandle && account.list.length > 1) {\n          target = account.list.find((ac) => ac.handle === activeChannelHandle);\n          if (!target) {\n            yt2.toast('warning', yt2.getI18n('YOUTUBE2_ERR_UNKNOWN_CHANNEL_HANDLE', activeChannelHandle));\n            target = account.active;\n          }\n        }\n        else {\n          target = account.active;\n        }\n        const pageId = target?.pageId || undefined;\n        const datasyncIdToken = target?.datasyncIdToken || undefined;\n        if (datasyncIdToken) {\n          identifier = {\n            type: 'datasyncIdToken',\n            value: datasyncIdToken,\n            pageId\n          };\n        }\n        else {\n          yt2.getLogger().warn('[youtube2] InnertubeLoader: signed in but could not get datasyncIdToken for fetching po_token - will use visitorData instead');\n        }\n      }\n    }\n    let poTokenResult;\n    if (identifier) {\n      yt2.getLogger().info(`[youtube2] InnertubeLoader: obtaining po_token by ${identifier.type}...`);\n      try {\n        poTokenResult = await this.#generatePoToken(identifier.value);\n        yt2.getLogger().info(`[youtube2] InnertubeLoader: obtained po_token (expires in ${poTokenResult.ttl} seconds)`);\n      }\n      catch (error: unknown) {\n        yt2.getLogger().error(yt2.getErrorMessage('[youtube2] InnertubeLoader: failed to get poToken: ', error, false));\n      }\n      if (poTokenResult) {\n        yt2.getLogger().info(`[youtube2] InnertubeLoader: re-create Innertube instance with po_token`);\n        this.#createInstance(Stage.PO, resolve, {\n          params: {\n            visitorData,\n            identifier,\n          },\n          value: poTokenResult.token,\n          ttl: poTokenResult.ttl,\n          refreshThreshold: poTokenResult.refreshThreshold\n        })\n          .catch((error: unknown) => {\n            yt2.getLogger().error(yt2.getErrorMessage(`[youtube2] InnertubeLoader: error creating Innertube instance:`, error));\n          });\n        return;\n      }\n    }\n    yt2.getLogger().warn('[youtube2] InnertubeLoader: po_token was not used to create Innertube instance. Playback of YouTube content might fail.');\n    this.#resolveGetInstanceResult(innertube, resolve);\n  }\n\n  static async #createInstance(stage: Stage.PO, resolve: (value: InnertubeLoaderGetInstanceResult) => void, poToken: POToken): Promise<void>;\n  static async #createInstance(stage: Stage.Init, resolve: (value: InnertubeLoaderGetInstanceResult) => void, poToken?: undefined): Promise<void>;\n  static async #createInstance(stage: Stage.Init | Stage.PO, resolve: (value: InnertubeLoaderGetInstanceResult) => void, poToken?: POToken) {\n    const usedParams: string[] = [];\n    if (poToken?.value) {\n      usedParams.push('po_token');\n    }\n    if (poToken?.params.identifier.pageId) {\n      usedParams.push('page_id');\n    }\n    const usedParamsStr = usedParams.length > 0 ? ` with ${usedParams.join(' + ')}` : '';\n    yt2.getLogger().info(`[youtube2] InnertubeLoader: creating Innertube instance${usedParamsStr}...`);\n    const innertube = await Innertube.create({\n      cookie: yt2.getConfigValue('cookie') || undefined,\n      visitor_data: poToken?.params.visitorData,\n      on_behalf_of_user: poToken?.params.identifier.pageId,\n      po_token: poToken?.value\n    });\n    switch (stage) {\n      case Stage.Init:\n        await this.#recreateWithPOToken(innertube, resolve);\n        break;\n      case Stage.PO:\n        this.#resolveGetInstanceResult(innertube, resolve, poToken);\n        break;\n    }\n  }\n\n  static reset() {\n    this.#clearPOTokenRefreshTimer();\n    if (this.#pendingPromise) {\n      this.#pendingPromise = null;\n    }\n    this.#innertube = null;\n  }\n\n  static #clearPOTokenRefreshTimer() {\n    if (this.#poTokenRefreshTimer) {\n      clearTimeout(this.#poTokenRefreshTimer);\n      this.#poTokenRefreshTimer = null;\n    }\n  }\n\n  static hasInstance() {\n    return !!this.#innertube;\n  }\n\n  static #resolveGetInstanceResult(innertube: Innertube, resolve: (value: InnertubeLoaderGetInstanceResult) => void, poToken?: POToken) {\n    this.#pendingPromise = null;\n    this.#innertube = innertube;\n    this.applyI18nConfig();\n    this.#clearPOTokenRefreshTimer();\n    if (poToken) {\n      const { ttl, refreshThreshold = 100 } = poToken;\n      if (ttl) {\n        const timeout = ttl - refreshThreshold;\n        yt2.getLogger().info(`[youtube2] InnertubeLoader: going to refresh po_token in ${timeout} seconds`);\n        this.#poTokenRefreshTimer = setTimeout(() => this.#refreshPOToken(poToken), timeout * 1000);\n      }\n    }\n    resolve({\n      innertube,\n    });\n  }\n\n  static #refreshPOToken(lastToken: POToken) {\n    const innertube = this.#innertube;\n    if (!innertube) {\n      return;\n    }\n    this.reset();\n    this.#pendingPromise = new Promise((resolve) => {\n      yt2.getLogger().info('[youtube2] InnertubeLoader: refresh po_token');\n      this.#recreateWithPOToken(innertube, resolve, lastToken)\n        .catch((error: unknown) => {\n          yt2.getLogger().error(yt2.getErrorMessage(`[youtube2] InnertubeLoader: error creating Innertube instance (while refreshing po_token):`, error));\n        });\n    });\n  }\n\n  static applyI18nConfig() {\n    if (!this.#innertube) {\n      return;\n    }\n\n    const region = yt2.getConfigValue('region');\n    const language = yt2.getConfigValue('language');\n\n    this.#innertube.session.context.client.gl = region;\n    this.#innertube.session.context.client.hl = language;\n  }\n\n  /**\n   * Required for initializing innertube, otherwise videos will return 403\n   * Much of this taken from https://github.com/LuanRT/BgUtils/blob/main/examples/node/index.ts\n   * @returns\n   */\n  static async #generatePoToken(identifier: string) {\n    const requestKey = 'O43z0dpjhgX20SCx4KAo';\n    const bgConfig: BgConfig = {\n      fetch: (url, options) => fetch(url as any, options as any) as any,\n      globalObj: globalThis,\n      identifier,\n      requestKey\n    };\n\n    const dom = new JSDOM();\n    Object.assign(globalThis, {\n      window: dom.window,\n      document: dom.window.document\n    });\n\n    const bgChallenge = await BG.Challenge.create(bgConfig);\n    if (!bgChallenge) {\n      throw new Error('Could not get challenge');\n    }\n\n    const interpreterJavascript = bgChallenge.interpreterJavascript.privateDoNotAccessOrElseSafeScriptWrappedValue;\n    if (interpreterJavascript) {\n      // eslint-disable-next-line @typescript-eslint/no-implied-eval\n      new Function(interpreterJavascript)();\n    }\n    else throw new Error('Could not load VM');\n\n    const poTokenResult = await BG.PoToken.generate({\n      program: bgChallenge.program,\n      globalName: bgChallenge.globalName,\n      bgConfig\n    });\n\n    return {\n      token: poTokenResult.poToken,\n      ttl: poTokenResult.integrityTokenData.estimatedTtlSecs,\n      refreshThreshold: poTokenResult.integrityTokenData.mintRefreshThreshold\n    };\n  }\n}\n"]}